---
title: Modelling
output: bookdown::html_chapter
bibliography: references.bib
---

```{r data, echo = FALSE, message = FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
options(digits = 2, width = 60, dplyr.print_min = 5, dplyr.print_max = 5)
knitr::opts_chunk$set(comment = "#>", compact = TRUE)

diamonds <- diamonds %>% tbl_df()
```

# Modelling for visualisation {#cha:modelling}

Modelling is an essential tool for visualisation. Models are particularly power because they allow you to decompose patterns. If you see a strong pattern in the data, a model lets you pull it out. You can examine both the model, particularly useful when you have multiple individuals, and what remains.

It has two main uses that I'll discuss in this chapter:

* Removing strong trends so that you can see the subtler patterns that remain.
  Or removing the effect of confounding variables so you can see the smaller 
  effects that remain.

* Summarising large amounts of data by fitting many models and visualise 
  the summary statistics of those models.

Another powerful use of modelling for visualisation is to transform the data in way that is more easily seen:

* Very large datasets can be summarised (using the ideas above). 

* Very high dimensionality datasets may need to be modified just to 
  get something you can see (e.g. with an ordination or a seriation.)
  
* Models (particularly Bayesian) can allow you to combine prior knowledge
  with scant data.
  
* ...

Unforuntately I don't have enough space to explain modelling in depth. But if you're familiar with linear models from other sources (e.g. X, Y & Z), this should allow you to deploy them in creative ways to improve your visualisations. If you don't know anything about linear models, I strongly encourage you to learn something. They'll help many of your visualisations show what's really important.

This chapter just scratches the surface of what you can do. But hopefully it reinforces how visualisation can play combine with modelling to help you build a powerful data analysis toolbox.

## Removing trend {#sub:trend}

Throughout this book, our analysis of the diamonds data has been plagued by the powerful relationship between size and price. It makes it very difficult to see the impact of the other c's (cut, colour and clarity) because higher quality diamonds tend to be smaller, and hence cheaper. We can use a linear model to remove the effect of carat on price, and instead of looking at the raw price, look at the adjusted price: how valuable this diamond is relative to the average diamond of that size.

We'll focus on diamonds two carats or less. This is 96% of the dataset. We'll also need to log transform both price and carat - this converts from a power relationship to a linear relationship:

```{r}
diamonds2 <- diamonds %>% 
  filter(carat <= 2) %>%
  mutate(
    lcarat = log(carat),
    lprice = log(price)
  )

ggplot(diamonds2, aes(lcarat, lprice)) + 
  geom_point()
```

(If you're wondering what the horizontal gap with no points is, go back to Section XYZ.)

We'll now fit a linear model to this data

```{r}
mod <- lm(lprice ~ lcarat, data = diamonds2)
coef(summary(mod))
```

If you have a classical statistics training, you might start by trying to interpret those model coefficients. With a little algebra we can verify that if $ln(price) = a + b * ln(carat)$ then $price = exp(a) * carat ^ b$. So this model tells us that $price = 4734 * carat ^ 1.69$.

But we're not going to interpret the model - we're just going to use it to subtract the trend out of the main plot. We're going to compute the residuals, given us the relative price. A plot of carat vs relative price shows that we've succeeded in removing the strong trend.

```{r, dev = "png"}
diamonds2 <- diamonds2 %>% 
  mutate(
    rel_price = resid(mod)
  )
qplot(carat, rel_price, data = diamonds2)
```

A relative price of zero represents same as average price for that carat. Negative price means cheaper than expected. Positive means more expensive than the average.

Normally the residuals give the absolute difference ($x - y$), but since we've log transformed the data it's going to be a relative difference ($log(x / y)$). You could back-transform it, to be more interpretable, but that would lose the nice properties of the log ratio, namely that it's symmetric (i.e. both relatively cheaper and relatively more expensive diamonds have the same range). We can make a little table to help interpret the values:

```{r, echo = FALSE}
xgrid <- seq(-1.5, 1.5, length = 11)
knitr::kable(data.frame(logx = xgrid, x = exp(xgrid)))
```

Now that we have the relative price, it's much easier to see the impact of the cut, colour and clarity of the diamonds. The pattern of the price isn't terribly strong, but it suggests that as the quality decreases, the average price _increases_. This is driven by lower quality diamonds tending to be larger. If instead we look at the relative price, you see the pattern that you expect: as the quality of the diamonds decreases, the relative price decreases.

```{r, dev = "png"}
color_cut <- diamonds2 %>% 
  group_by(color, cut) %>%
  summarise(
    price = mean(price), 
    rel_price = mean(rel_price)
  )

ggplot(color_cut, aes(color, price)) + 
  geom_line(aes(group = cut), color = "grey80") +
  geom_point(aes(colour = cut), size = 3)

ggplot(color_cut, aes(color, rel_price)) + 
  geom_line(aes(group = cut), color = "grey80") +
  geom_point(aes(colour = cut), size = 3)
```

This technique can be employed in a wide range of situations. Wherever you can explicitly model a strong pattern that you see in a plot, it's worthwhile to use a model to remove that strong pattern so that you can see what interesting trends remain. In the diamonds data, it really is essential to focus on relative price.

### Exercises

1.  There's an area in the top-right of the plot of carat vs. relative price 
    that doesn't have any points in it. What does that area represeent? 

1.  I made an unqualitied assertion that lower-quality diamonds tend to 
    be larger. Support my claim with a plot.

1.  Can you create a plot that simultaneously shows the effect of colour,
    cut and clarity on relative price? If there's too much information to
    show on one plot, think about how you might create a sequence of plots
    to convey the same message.

1.  How do depth and table relate to the relative price? How do the patterns
    compare to the untransformed price?
    
## Visualising models {#sub:modelvis}

In the example above we used a linear model as a tool for removing trend. We didn't care about the model itself, just what it could do for us. Another way of using models is to pay more attention to the model, and display it in the plot. To do that, we need some way of turning a model into a data frame so that we can apply everything we've learned about ggplot2 so far.

We're going to do that with the __broom__ package, which provides three key verbs for converting models into data frames:

* `augment()`: one row for each row in the original data set. Variables are
  observation level summaries like residuals and influence metrics.

* `tidy()`: one observation for each coefficient in the model.

* `glance()`: one observation for each model. It's not that useful when you
  only have one model - we'll see it used more in the next section.

```{r}
library(broom)
tbl_df(augment(mod))
tidy(mod)
glance(mod)

```

\begin{table}
  \centering
  \begin{tabular}{lp{2.5in}}
    \toprule
    Variable & Description \\
    \midrule
    \texttt{.cooksd}   & Cook's distances \\
    \texttt{.fitted}   & Fitted values \\
    \texttt{.hat}      & Diagonal of the hat matrix \\
    \texttt{.resid}    & Residuals \\
    \texttt{.sigma}    & Estimate of residual standard deviation when corresponding observation is dropped from model \\
    \texttt{.stdresid} & Standardised residuals \\
    \bottomrule
  \end{tabular}
  \caption{The diagnostic variables that \texttt{fortify.lm} assembles and adds to the model data.}
  \label{tbl:fortify-vars}
\end{table}


## Fitting multiple models {#sub:multiple-models}

## Learning more


* The [broom README](https://github.com/dgrtwo/broom), gives a more detailed
  overview of broom and points you to the latest resources on where to learn 
  more.
