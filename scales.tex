\input{_header.tex}
\chapter{Scales, axes and legends}

\section{Introduction}

Scales control the mapping between data and aesthetics.  They convert abstract data values into concrete aesthetics that you can perceive and that R can understand, such position, colour, shape, size, and line type.  You don't have to learn about scales, because \ggplot will automatically add default scales when needed, but understanding how scales work and how you can control them gives you much more control over your plots. This chapter covers:

\begin{itemize}
  \item How scales work (\S \ref{sec:how-scales-work}).
  \item Using scales: their names, arguments and roles.
  \item More details about individual scales.
  \item Controlling the appearance of axes and legends.
\end{itemize}

This section describes the basic operation of a scale, the details of all the different scales and instructions on how to make your own.

\section{How scales work}
\label{sec:how-scales-work}

A scale is a function from a region in data space (the domain) to a region in aesthetic space (the range).  While the range of the scale is specified during construction, the domain must be learning from the data. For continuous variables, the this is an interval on the real line (stored as a numeric vector of length 2), and for discrete variables it is set of values (stored as a character vector).  For example, in the mammals sleep dataset, the domain of the continuous variable \var{bodywt} variable is $[0.005, 6654]$, and the domain of the discrete variable \var{vore} is \{carni, herbi, omni\}.

The each scale also has range.  For discrete scales, this is just a vector of aesthetic values corresponding to the input values.  For continuous scales, this will be a 1d path some more complicated space.  For example, the continuous colour scales have a range which is a path through colour space.

The process by a scale learns the domain is called training, and takes place in three steps when the plot is drawn: transformation, domain calculation and mapping.  

\begin{itemize}
	\item  For continuous data, it is often useful to display a transformation of the data, like a logarithm or square root.  The {\bf transform} step performs this transformation, before any statistical summaries are calculated.  This ensures that a plot of $log(x)$ vs $log(y)$ on linear scales looks the same as $x$ vs $y$ on log scales.  Transformations are described in more depth in Section~\ref{sec:trans}. 

	\item After the statistics are computed, the {\bf domain} is calculated for the data in each layer.  The individual domains are then combined to get a global domain, across all layers and facets.  
	
	Training can be overridden by manually setting the domain of the scale with the {\tt limits} argument, as described in Section~\ref{sec:scale-usage}.  Any data values outside of the domain of the scale, will be set to \code{NA}.

	\item Now that both global domain and range are known, the scaling function can be applied to {\bf map} data values to aesthetic values.  Nothing needs to be done for some scales: for example, for continuous position scales, all the difficult work has already been done by the transformation step.
	
\end{itemize}

\section{Using scales}
\label{sec:scale-usage}

Table~\ref{tbl:scale_list} lists all the built-in scales.  To add a scale to your plot, you create a scale object and then add it (using \code{+}) to your plot. Scale constructors have a common naming scheme.  They all start with \code{scale_}, followed by the name of the aesthetic, followed by by the name of the scale. For example, to use the Brewer colour scale for fill, you would add {\tt scale\_fill\_brewer()} on to your plot.  

% TABLE
%  CAPTION: List of all scales, arranged by the aesthetic that they apply to
%  LABEL: tbl:scale_list
%
% source("scales-list.r")

\input{scale-desc}

As well as having a common naming scheme, all scales share a set of common arguments.  These arguments control the basic operation of the scale and are described below.

\begin{itemize}
  \item {\bf name}:  the label which will appear on the axis or legend. You can supply text strings (using ``$\backslash$n'' for line breaks) or mathematical expressions (as described by \verb|?plotmath|):
  
  \begin{figure}[htbp]
    \centering
      \includegraphics[width=0.33\textwidth]{scales-name-1}%
      \includegraphics[width=0.33\textwidth]{scales-name-2}%
      \includegraphics[width=0.33\textwidth]{scales-name-3}
    \caption{Legends with names given by (from left to right): {\tt "Tip rate"}, {\tt "The amount of the tip$\backslash$ndivided by the total bill"} and {\tt expression(frac(tip, total\_bill)} }
    \label{fig:legend-names}
  \end{figure}
  
  % decumar<<< 
  % interweave({
  % p <- qplot(tip, total_bill, data=tips, colour=tip/total_bill)
  % p + scale_colour_hue("Tip rate")
  % p + scale_colour_hue("The amount of the tip\ndivided by the total bill")
  % p + scale_colour_hue(expression(frac(tip, total_bill))
  % })
  % |||
  % >>>

  \item {\bf limits}: fixes the domain of the scale.   Continuous scales take a numeric vector of length two; discrete scales a character vector. If limits are set, no training of the data will be performed.  
  
  There are shortcut functions for setting the limits of continuous x and y scales: \f{xlim} and \f{ylim}.  Each has two arguments, specifying the new domain, and create a scale object.  
  
  Particularly useful for zooming (limits smaller than range of data), and ensuring that limits are consistent across multiple plots (limits larger than range of some subsets of data).  
  
  Any value not in the domain of the scale is not displayed (i.e.\ for an observation to be displayed it must be in the domain of every scale on the plot)

  \item {\bf breaks} and {\bf labels}: control where tick marks appear on the axis or what values appear on the legend.  If {\tt labels} is set, you must also specify {\tt breaks}, so that the two can be matched up correctly.  Breaks differs from limits in that it affects what appears on the guide, not what appears on the plot.  This is illustrated by Figure~\ref{fig:breaks_vs_legends}.
  
  % Alternatively, both breaks and labels can be a function with a single  argument, range, that returns a numeric vector (for breaks) or a character vector (for labels) with desired break positions and labels.
\end{itemize}

\begin{figure}[htbp]
  \centering
    \includegraphics[width=0.33\textwidth]{scales-unlimited}%
    \includegraphics[width=0.33\textwidth]{scales-breaks}%
    \includegraphics[width=0.33\textwidth]{scales-limits}
  \caption{The difference between breaks and legends.  (Left) default plot.  (Middle)  {\tt breaks = c(4.5,5.5)} and (right) {\tt limits = c(4.5,5.5)}.}
  \label{fig:breaks_vs_legends}
\end{figure}

There are many other arguments to individual scales, described by the documentation for the individual scales.  You can use the either the R (e.g.\ {\tt ?scale\_brewer}), or the online documentation (\url{http://had.co.nz/ggplot2}).  The online documentation includes output.

\subsection{Default scales}
\label{sub:default_scales}

Every aesthetic has a default scale that is added to the plot whenever you use that aesthetic in a layer.  These are listed in Table~\ref{tbl:default-scales}.

\begin{table}
  \begin{center}
  \begin{tabular}{lll}
    \toprule
    Aesthetic & Discrete & Continuous \\
    \midrule
    Colour and fill & hue & gradient \\
    Position & discrete & continuous \\
    Shape & shape & --- \\
    Line type & linetype & --- \\
    Size & ---  & size \\
    \bottomrule
  \end{tabular}
  \end{center}
  \caption{Default scales, by aesthetic and variable type.  The default scale varies depending on whether the variable is continuous or discrete.  Shape and line type do not not have a default continuous scale; size does not have a default discrete scale.}
  \label{tbl:default-scales}
\end{table}

The following example shows the difference between the default discrete and continuous scales for colour, as well as how to override the default scale.

% FIGURE
%  COL: 3
%  LABEL: scale-defaults
%  CAPTION: 
% 
% p <- qplot(sleep_total, sleep_cycle, data=msleep, colour=vore)
% p 
% p + scale_colour_discrete("What does\nit eat?", 
%    breaks = rev(c("herbi", "carni", "omni", NA)), 
%    labels = rev(c("plants", "meat", "both", "don't know")))
% p + scale_colour_brewer(pal="Set1")

The default colour scale for discrete values uses equally spaced hues, the default scale for continuous values uses a gradient of colours between blue and yellow, and the Brewer colour scale uses colours selected to work well in a variety of situations (see \url{http://colorbrewer.org} for more detail).

As well as referring to scales explicitly by name, as in Section~\ref{sec:scale-usage}, you can also refer to the default scales with  scale name {\tt discrete} or {\tt continuous}.  For example, the default discrete colour scale is \code{scale_colour_discrete}.  You can change the default scales with \code{set_default_scale(aesthetic, variable_type, scale_name, ...)}.  Extra arguments are passed to the scale constructure.  For example, if you wanted to set up default black and white colours scales you could do:

% LISTING
% 
% set_default_scale("colour", "discrete", "grey")
% set_default_scale("colour", "continous", "gradient", 
%  low = "white", high = "black"
% )

% Having to specify the type of variable (continuous or discrete) seems like extra work: why can't ggplot2 figure that out by itself?  Well, it can't because you can create the scales independently of (and before) the plot.  Allows you to create scales independently of the plot.  


\section{More details}
\label{sec:scale_special}

There are two special types of scales that work for all aesthetics.  They are the manual and identity scale.  

The identity scale is used when your data is already in a form that the plotting functions in R understand: size in mm, colour as \verb|"#RRGGBB"| etc. Because there are no labels associated with such data, the identity scale will not draw a legend unless you also provide labels and breaks, as described above. 

\begin{figure}[htbp]
  \centering
    \includegraphics[width=0.5\textwidth]{scale-identity}
  \caption{A plot of R colours in Luv space.  Points are coloured according to their colour, with .  A legend is unnecessary, because the colour of the points represents itself.}
  \label{fig:scale-identity}
\end{figure}

The manual scale is useful for creating your own discrete scales.  It has one important argument, \verb|values| in which you specify the values that the scale should produce.  If this vector is named, it will match the values of the output to the values of the input, otherwise it will match in order of the levels of the discrete variable.  If you use \verb|scale_manual| be careful to ensure that they are perceptually well founded.

\section{Transformers}
\label{sec:trans}

Every continuous scale takes a {\tt trans} argument.  This argument allows to specify a non-linear transformation.  The transformation is carried out by a transformer, which describes the transformation, it's inverse and where to place labels. Table~\ref{tbl:common-trans} lists some of the more common transformers. A complete list is available in the documentation for {\tt transformation}.

\begin{table}
  \centering
  \begin{tabular}{lll}
    \toprule
    Name & Function $f(x)$ & Inverse $f^{-1}(x)$ \\
    \midrule
    asn       & $\tanh^{-1}(x)$ & $\tanh(x)$ \\
    exp       & $e ^ x$         & $\log(x)$  \\
    identity  & $x$             & $x$        \\
    log       & $\log(x)$       & $e ^ x$    \\
    log10     & $\log_{10}(x)$  & $10 ^ x$   \\
    log2      & $\log_2(x)$     & $2 ^ x$    \\
    logit     & $\frac{1}{1 + e(x)} $ & $\log(\frac{x}{1 - x})$ \\
    pow10     & $10^x$          & $\log_{10}(x) $ \\
    probit    & $\Phi(x)$       & $\Phi^{-1}(x)$ \\
    recip     & $x^{-1}$        & $x^{-1}$ \\
    reverse   & $-x$            & $-x$     \\
    sqrt      & $x^{1/2}$       & $x ^ 2$  \\
    % power     & $\frac{x^p - 1}{p * sgn(values - 1)}$ & $|values| * p + 1 $ 
    \bottomrule
  \end{tabular}
  \caption{List of built transformers.}
  \label{tbl:common-trans}
\end{table}

Because transformations are so commonly used to modify position scales, there is a shortcut for x, y, and z scales: \verb|scale_x_continuous(trans = "log10")| can be written as \verb|scale_x_log10()|.

You can also perform the transformation by hand.  For example instead of adding {\tt scale\_x\_log}, you could plot {\tt log(x)}.  These produce identical graphics except for one difference: the axis labels.  If you use a transformed scale, the axes will be labelled with the original values.  Figure~\ref{fig:trans} illustrates this difference.

\begin{figure}[htbp]
  \centering
    \includegraphics[width=0.5\textwidth]{trans-scale}%
    \includegraphics[width=0.5\textwidth]{trans-data}
  \caption{A scatterplot of diamond price vs carat illustrating the difference between log transforming the scale (left) and log transforming the data (right).  The plots are identical, but the axis labels are different.}
  \label{fig:trans}
\end{figure}

Scale transformation occurs before the statistic is calculated.  Transformers are also used in \verb|coord_trans|, where the transformation occurs after the statistic has been calculated, and affect the shape of the grob.  \verb|coord_trans| is described in more detail in Section XXX.

Section XXX describes how to write your own transformers.

\section{Legends and axes}
\label{sec:legends_and_axes}

In ggplot2, legends and axes are produced automatically based on the scales.  This section describes how legends are produced from the scales and the geoms that use them, as well as ways that you can customise them.

\begin{figure}[htbp]
  \centering
  \caption{Figure containing axis and legends, with pieces labelled.  }
  \label{fig:labelled-guides}
\end{figure}

Because all information about what is on the plot is stored in the plot object, ggplot2 can normally do a very good job of anticipating what legend you want.  

This requires collecting information about how each aesthetic is used from a couple of different places.  Firstly, we need information from the scale about the values in the original data, and their presentation on the plot.  The scale returns a list of ``keys'' (analogous to ticks on the axis), which associated the data values with their aesthetic appearance.  Then we figure out which geoms have used that aesthetic - we need this information so that we can display the aesthetics in the correct way.  For example, the point geom has points in the legend key and the lines geom has lines.  If both points and lines are used then both will be drawn.

\begin{itemize}
  \item For each aesthetic used in the plot, list all geoms that use that aesthetic. 
  \item 
\end{itemize}

This process requires a few (not unreasonable) assumptions:

\subsection{Customising appearance}

While ggplot2 will generally do a pretty good job at figuring out what the legend should look like, sometimes you will need to do some tweaking to get the legends looking exactly the way that you want.  Described below are some of the useful scale arguments and theme parameters that affect the appearance of legends.  

\begin{itemize}
  \item The {\tt breaks} and {\tt labels} arguments, described above, are particularly important because they control what tick marks appear on the axis and what keys appear on the legend.  If the breaks chosen by default are not appropriate (or you want to use more informative labels) setting these arguments will adjust the appearance of the legend keys and axis tick marks.  
  
  \item The theme settings {\tt axis.text}, {\tt axis.box}, ... control the visual appearance of the legend.  For more details on how to manipulate these settings, see Section~\ref{sec:theming}.

  \item The internal grid lines are controlled by the breaks and minor breaks arguments.  By default minor grid lines are spaced evenly in the original data space - this gives the common behaviour of log-log plots where major grid lines are multiplicative and minor grid lines are additive.  You can override the minor grid lines with the {\tt minor\_breaks} argument.
  
  \item Position of legends.  Plot level option setting: {\tt legend.position}, can be one of right, left, top or bottom; or none to not display the legend; or a numeric vector of length 2.  {\tt legend.justification}
  
  \item Position scales also have the {\bf expand} argument, which controls the amount of extra space added to the limits.  This is a numeric vector of length two: the first number is the multiplicative and the second is additive.  Default for continuous scale is {\tt c(0.05, 0)} (i.e.\ add 5\% extra space on each end) and for discrete {\tt c(0, 0.75)}).  Set to {\tt c(0, 0)} to have no extra space.  This is added on top of any specified limits.
  
\end{itemize}

\subsection{Legend merging}

ggplot2 tries to minimise the number of legends that are displayed.  It does this by combining legends for the same variable.  Figure~\ref{fig:legend-merge} shows an example of this.  In order for legends to be merged, they must have the same title.  For this reason, if you change the title of one of the merged legends you'll need to change it for all of them.

\begin{figure}[htbp]
  \centering
  \caption{Colour legend, shape legend, colour + shape legend.}
  \label{fig:legend-merge}
\end{figure}

A legend will be drawn for each aesthetic attribute.  Every geom that uses that aesthetic will appear in the legend in some way.

\input{_footer.tex}