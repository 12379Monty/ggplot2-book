\input{_header.tex}

% decumar<<< 
% source("~/documents/ggplot/ggplot/load.r")
% library(xtable)
% doptions(width=8, height=4.8, lscale=0.5)
% ggopt(axis.color = "black")
% set.seed(1410)
% dsmall <- diamonds[sample(nrow(diamonds), 1000),]
% >>>

\chapter{Adding extra layers}

\section{Details}\label{sec:details}

All geom functions start with {\tt geom} and are singular, eg. {\tt geom\_point}, {\tt geom\_errorbar}.  They all have the following basic form:

\begin{alltt}
geom_XXX <- function(plot, aesthetics, data, ...) {}
\end{alltt}

\noindent and they take three types of input:

\begin{itemize}
	\item Plot and data settings: {\tt plot}, the plot to add the geoms to. If not specified, this will use the ``current'' plot, i.e. the plot which was last modified. Note that this can differ from the plot currently displayed on screen.  {\tt data} (optional), a data set to get the data from
	\item Aesthetic mappings: {\tt aesthetics} (optional), a list describing which variables should be mapped to which aesthetics.  If not specified, these will be drawn from the defaults in the plot object
	\item Other parameters which differ from geom to geom.  These parameters control various settings of the geom, for example, bin width in the histogram, or bandwidth for a loess smoother.  Any aesthetic can also be used as a parameter, in which case it will be applied to all points.
\end{itemize}

Geom functions add geoms to a plot object, as you can see in the following example.

\begin{alltt}
p <- geom_plot(data=mtcars, aes=list(x=mpg, y=wt))
str(p$geoms) 
str(geom_point(p)$geoms)
str(p$geoms)
p <- geom_point(p)
str(p$geoms)
\end{alltt}

\section{Limitations of qplot}
\label{sec:qplot-limitations}

\begin{itemize}
  \item Can't use different aesthetic mappings on different layers.  
  \item Can't use different parameters on different layers
  \item Can't change coordinate systems.  Can only have linear or log transformed axes, not any other function.
  \item Can't change scales.
\end{itemize}

Remember, you can always start with a plot created by {\tt qplot()} and then add on the layers and scales etc as you if you had started with {\tt ggplot()}.  If you do this, {\tt geom\_blank} can be useful for {\tt qplot()} because it's a geom that doesn't draw anything.

\section{Translating between qplot and ggplot}
\label{sec:qplot-ggplot}


\begin{alltt}
qplot(x, y, data, shape=shape, colour = colour)
ggplot(data, aes(x, y, shape=shape, colour = colour)) + geom_point()
\end{alltt}

\begin{alltt}
qplot(x, y, data, shape=shape, colour = I("red"))
ggplot(data, aes(x, y, shape=shape)) + geom_point(colour="red")
\end{alltt}

The differences between setting and mapping are described in more detail in Section~\ref{sec:setting-mapping}.

\begin{alltt}
qplot(x, y, data, geom=c("line", "smooth"))
ggplot(data, aes(x, y)) + geom_line() + geom_smooth()
\end{alltt}

\begin{alltt}
qplot(x, y, data, geom=c("line", "smooth"), method="lm")
ggplot(data, aes(x, y)) + geom_line() + geom_smooth(method="lm")
\end{alltt}


\begin{alltt}
qplot(x, y, data, log="xy")
ggplot(data, aes(x, y)) + scale_x_log10() + scale_y_log10()
\end{alltt}

Section~\ref{sec:transformers} describes more possible transformations of the x and y scales.

\begin{alltt}
qplot(x, y, data, main="title", asp = 1)
ggplot(data, aes(x, y)) + opts(title = "title", aspect.ratio = 1)
\end{alltt}

Section~\ref{sec:plot_options} lists all possible plot options and their effects.



% \section{The pipeline}\label{sec:the_pipeline}
% 
% Another way of thinking about the grammar of graphics is as a pipeline which takes in raw data and outputs plots.  Each stage of the pipeline performs a transformation described by one of the components of the grammar.  For example, one of the first stages performs the statistical transformation described by the stat component.  
% 
% [Insert diagram of the pipelines here.]
% 
% You will notice there are two passes of the 
% 
% 
% \subsection{Differences from Wilkinson's grammar}
% 
% The pipelines of ggplot and the GoG differ slightly.  In ggplot, every stage takes a data frame as input and returns a data frame as output, apart from the final stage, which outputs grid grobs (graphical objects).  The GoG has three intermediate data formats: a varset (the same as a data frame), a graph and a graphic.
% 
% [Insert diagram of the pipelines here.]
% 
% The pipeline is a little more complicated when multiple data sources and geoms are involved.  The complication arises because all data must share the same scales and coordinate system, but may use different mappings, geoms and statistics.  All pipelines must share the same coordinate system, so this is where the connection occurs.  For this reason, ggplot has the layer, as discussed above, which combines the geom, stat, data and mapping.
% 
% [Insert more complicated diagram here]


\section{Setting vs. mapping}
\label{ref:setting-mapping}

If you want to use the defaults you set up when creating the plot object, you just use the geom function like:

\begin{alltt}
p + geom_line()
\end{alltt}

This will create a new plot object with an addition layer that joins points with lines.  (To see how to control what sets of observations form a line, see Section~\ref{sec:grouping}) lines geom added to its list of geoms.   You can also add more aesthetics, or specify a different data set to use instead of the default.  

\begin{alltt}
p + geom_line(aes(colour=a, size=b), data=new.data.frame))
\end{alltt}

If there is a default aesthetic you want to unset, use {\tt NULL}:

\begin{alltt}
p + geom_line(p, aes(colour=NULL))
\end{alltt}

If the plot is facetted, and the new data set does not contain the faceting columns, then the data set will be duplicated for each value of the missing columns.  This has the effect of displaying the data in every facet.  This is explained in more detail, with examples, in chapter XXX, page X.

For every aesthetic the geom function understands, you can also supply that aesthetic as an option to the function.  Instead of mapping data to that aesthetic, this will change the default.  For example.

\begin{alltt}
p + geom_line(colour="red")  
\end{alltt}

\noindent will set the line colour to be red instead of black.  Other examples:

\begin{alltt}
p + geom_line(size=3)  
p + geom_line(size=3, colour="blue")  
\end{alltt}

\section{Mastering grouping}
\label{sec:grouping}

There are also a couple of aesthetic attributes that can't be perceived directly.  The most important of these is the {\tt group} aesthetic, which divides the the data set into discrete components.   This is used in line and path plots to separate the data for different lines, and in the groups grob to divide the different groups. 

By default, the group aesthetic is set to the combination (interaction) of all discrete variables used in the plot.  Generally, this will create the correct separation of the data, but sometimes you will need to override it.  For example, if you want lines connecting observations with a discrete x scale you will need to manual specify the group aesthetic.  This section illustrates a few possible applications when this is useful.

The {\tt interaction()} function is particularly useful if there isn't a preexisting variable that separates the groups you are interested in, but a combination of variables does.  

\section{Geoms}
\label{sec:geoms}

\section{Stat}
\label{sec:stat}

\section{Position adjustments}
\label{sec:position}




\input{_footer.tex}
