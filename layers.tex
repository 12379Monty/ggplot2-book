\input{_header.tex}

\chapter{Build a plot layer by layer}
\label{cha:layers}

\section{Introduction}

As described in the previous chapter, layers can contain different data sets and use different aesthetic mappings.  When creating a plot with \f{qplot}, you can't access these differences - all layers use the same default dataset and aesthetic mappings.  This means that you can't create certain more complex plots with {\f qplot}.  This chapter outlines an alternative method: building up the plot layer by layer.  

Section~\ref{sec:ggplot} will show you how to create a plot object, containing just the default data and aesthetics that you specify.  To build something that you can actually see, you will need to add layers to the plot, as described by Section~\ref{sec:layers}.  Sections~\ref{sec:data} and \ref{sec:aes} describe the data and aesthetic mappings in more detail, including more information about how layer settings override the plot defaults, the difference between setting values and mapping aesthetics, and the important group aesthetic.  Sections~\ref{sec:geom} and \ref{sec:stat} list all of the geoms and stats available in \ggplot and finally Section~\ref{sec:pull-together} describes how unusual combinations of geoms and stats create new types of plots.

This chapter is mainly a technical description of how layers, geoms and statistics work - how you call and customise them.  The next chapter, the ggplot ``toolbox'', describes how you can use different geoms to achieve various data analytic displays.  I'd recommend flicking between these two chapters in practice so you can learn both how layers work, and how you can use them to achieve your goals.

\section{Creating a plot}
\label{sec:ggplot}

To build up a plot layer by layer, we first need a plot object.  One way to create a plot object, is with \f{qplot}.  Most of the time, qplot saves you time because it makes educated guesses about what you actually want.  However, using \f{qplot} you do not gain access to the full power of \ggplot because the capabilities to customise layers are much reduced.

% \begin{itemize}
%   \item Can't use different aesthetic mappings on different layers.  
%   \item Can't use different parameters on different layers
%   \item Can't change coordinate systems.  
%   \item Can't change scales.  Can only have linear or log transformed axes, not any other function.
% \end{itemize}

An alternative way to create a plot object is to call \f{ggplot}, which has two optional arguments: the default {\bf data} and aesthetic {\bf mapping} for the plot.  Data needs little explanation: it's the data frame that you want to visualise.  You are already familiar with aesthetic mappings from \f{qplot}, and the syntax here is quite similar, however you need to wrap the pairs of aesthetic attribute and variable names in an \f{aes} call, as in the following example.

\begin{alltt}
ggplot(mtcars, aes(x = wt, y = mpg, colour = cyl))
\end{alltt}

These arguments are defaults for the plot, and can be omitted if you specify data and aesthetics when adding each layer.  

The result of calling \f{ggplot} is the same as the result of qplot: a ggplot object.  However, the plot created by ggplot can't be rendered: it doesn't actually have anything to draw.  You need to add some layers.

Plots created in either manner are identical.  To see this look at the \f{qplot} code - it creates a plot with \f{ggplot}, then adds layers.  If you want to see in more detail how qplot syntax can be converted to ggplot, Appendix~\ref{cha:translating} gives more details. In practice, use whatever works for you - personally, I use whatever requires the least amount of typing.

% The difference between plots created by \f{qplot} and \f{ggplot} is that the former is already a complete plot, you are just adding extras to it, while with \f{ggplot} you need to add layers before it can be rendered.  
% 

\section{Layers}
\label{sec:layers}

A layer encapsulates all of the information needed to draw most normal plots:  the data, mapping from the data to aesthetic attributes that can be perceived, a way of representing the data, and an optional statistical transformation.  A first the statistical transformation may not seem like it belongs here - but many common plots incorporate some kind of statistical summary, for example, the histogram or adding a smoothed line to a plot.  

There are two ways to create layers.  The first way (long-hand) is to use the layer function:

\begin{alltt}
layer(geom, geom_params, stat, stat_params, data, mapping, position)
\end{alltt}

\noindent Here you specify the geom to use, its parameters; the stat, its parameters; data and aesthetic mapping (just like for \f{ggplot}) and a position adjustment (described in Section~\ref{sec:position}).  So, if you want to create layer for a scatterplot, you'd do something like:

\begin{alltt}
layer(geom = "point", stat = "identity", position = "identity")  
\end{alltt}

\noindent Or for a customised histogram with a grey background and an bin width of 2:

% LISTING
% 
% layer(
%   geom = "smooth", 
%   geom_params = list(fill = "grey50"),
%   stat = "smooth",
%   stat_params = list(binwidth = 2)
% )

\noindent  This specification is precise, but verbose.  However, most of the time, you will use a shortcut.  The shortcut is possible because associated with every geom is a default statistic and position, and with every statistic is a default geom.  This means that you only need to specify one of stat or geom to get a completely specified layer.  The two examples above would become:

% LISTING
% 
% geom_point()
% geom_histogram(binwidth = 2, fill = "grey50")

All the shortcut functions start with {\tt geom\_} or {\tt stat\_} and are singular, eg. {\tt geom\_point}, {\tt stat\_bin}.  They all have the same  basic form:

\begin{alltt}
geom_XXX(mapping, data, ..., geom, position)
stat_XXX(mapping, data, ..., stat, position)
\end{alltt}

\noindent and they have common parameters, which describe the components of the layer:

\begin{itemize}
	\item Aesthetic {\bf mapping} (optional), specified by the {\tt aes()} function, and combined with the plot defaults as described in Section~\ref{sec:aes}.

	\item The {\bf data} to use (optional).  You can use this to override the default plot data set.  Otherwise, it omitted  (as you will do most of the time), it will use the default plot data.
	
	\item Other parameters which differ from geom to geom, and stat to stat.  These parameters control various settings of the geom and statistic, for example, bin width in the histogram, or bandwidth for a loess smoother.  Any aesthetic that the geom recognises can also be specified as a parameter to the plot.  See Section~\ref{sub:setting-mapping}.
	
	\item For geoms, you can override the default {\tt stat}, and for stats the default {\tt geom}.  This should be a text string containing the name of the geom to use.  Using the default will give you a standard plot - if you want something more exotic, overriding the defaults gives you more freedom.  This is described in more detail in Section~\ref{sub:new_plot_types}.
  
\end{itemize}

After creating the layer, you'll typically combine it with a plot using  \code{+}:

% LISTING
% 
% qplot(mtcars, aes(mpg, wt)) + geom_point()
% qplot(mtcars, aes(mpg, wt, colour = factor(cyl))) + geom_smooth()
\input{_include/8eb2b797db8fe15c5b5c9a09887e3843.tex}
% END

\noindent The summary function can be helpful for inspecting the structure of a plot without plotting it:

% INTERWEAVE
%
% p <- ggplot(data=mtcars, aes(mpg, wt))
% summary(p)
% p <- p + geom_point(p)
% summary(p)

Notice that the order of data and mapping is switched between {\tt ggplot()} and the layer functions.  This is for good reason - you almost always specify data for the plot, and almost always specify aesthetics (but not data) for the layers.  To keep your code readable, I suggest always explicitly naming other arguments, rather than relying on positional matching.

The following sections describe the data and aesthetic mappings in more detail, then go on to describe in what geoms and statistics are available and how they work.

\section{Data}
\label{sec:data}

The restrictions on the data used in \ggplot are simple: it must be a data frame.  You only need to have a default data if you are using faceting.  This is because faceting is a global operation (i.e. works on all layers) and it needs to have some base dataset to add in any missing columns.  See Section~\ref{sub:missing_faceting_columns} for more details.  Otherwise, a default dataset will usually save you some typing, but is not mandatory.

Another thing to remember is that the data is stored in the plot object, as a copy, not a reference.  If you want to update (or change) the data later on, you can add on a new dataset with \code{\%+\%}:

% WEAVE
% 
% p <- ggplot(mtcars, aes(mpg, wt, colour = cyl)) + geom_point()
% p
% mtcars$cyl <- factor(mtcars$cyl)
% p %+% mtcars

\noindent This can be useful if you need to produce the same plot for different datasets.

\section{Aesthetic mapping}
\label{sec:aes}

To describe the way that variables in the data are mapped to things that we can perceive on the plot (the ``aesthetics''), we use the {\tt aes} function.  The {\tt aes} function takes a list of aesthetic-variable pairs as follows:

\begin{alltt}
aes(x = weight, y = height, colour = age)
\end{alltt}

Here we are mapping x-position to weight, y-position to height and colour to age.  Alternatively, the first two arguments can be left without names, in which case they are assumed to be for the x and y variables.  (This matches the way that \f{qplot} is normally used.)

\begin{alltt}
aes(weight, height, colour = age)
\end{alltt}

Things inside \f{aes} can be functions, but all variables must be contained inside the plot (or layer) data.  This is important because ggplot2 objects are entirely self-contained.  You can save one to disk and later plot it without needing anything else from that session.

Mappings are stored in two places: in the plot defaults and in individual layers.  The plot defaults can be set when the plot is created, or added on afterwards

\begin{alltt}
p <- ggplot()
summary(p)
summary(p + aes(wt, hp))
\end{alltt}

When you add a layer to a plot, you can just use the default mapping: 

\begin{alltt}
p + geom_line()
\end{alltt}

\noindent.  If you want to override the defaults, Table~\ref{tbl:aes-override} summarises the rules.

\begin{table}
  \begin{center}
  \begin{tabular}{lll}
    \toprule
    Operation & Layer aesthetics  & Result \\
    \midrule
    Add       & colour = cyl & x = mpg, y = wt, colour = cyl \\
    Override  & y = disp     & x = mpg, y = disp \\
    Delete    & y = NULL     & x = mpg \\
    \bottomrule
  \end{tabular}
  \end{center}
  \caption{Rules for combining layer aesthetic mapping with default mapping of \code{aes(x = mpg, y= wt)}:  additional aesthetics are added, existing overridden, and {\tt NULL} removes.}
  \label{tbl:aes-override}
\end{table}


\subsection{Setting vs. mapping}
\label{sub:setting-mapping}

For every aesthetic the geom function understands, you can also set that aesthetic as an parameter to the function.  Aesthetics can vary for each observation being plotted, while parameters are the same.  Instead of mapping data to that aesthetic, this will change the default.  For example:

\begin{alltt}
p <- ggplot()
p + geom_point(colour="red")  
\end{alltt}

\noindent will set the line colour to be red instead of black.  This is quite different to:

\begin{alltt}
p + geom_point(aes(colour="red"))
\end{alltt}

\noindent which effectively creates a new column with the value ``red'' repeated according to R's vector recycling rules and then uses the default colour scale to map that value to a colour. Chapter~\ref{cha:specifications} describes how values should be specified for the various aesthetics.  

With qplot, you can do the same thing by putting the value in {\tt I()}:

\begin{alltt}
  qplot(mpg, wt, data=mtcars, colour = "red")
  qplot(mpg, wt, data=mtcars, colour = I("red"))
\end{alltt}


\subsection{Grouping}
\label{sub:grouping}

The {\tt group} aesthetic which divides the the data set into discrete components.   This is used by the line geom to determine which observations to connect; by the boxplot geom, to determine which points to summarise in one box; by the smooth geom to determine which group of points should be included in the smooth.

By default, the group aesthetic is set to the combination (interaction) of all discrete variables used in the plot.  Generally, this will create the correct separation of the data, but sometimes you will need to override it.  For example, if you want lines connecting observations with a discrete x scale you will need to manual specify the group aesthetic.  


% WEAVE
% 
% 
Examples.



The {\tt interaction()} function is particularly useful if there isn't a pre-existing variable that separates the groups you are interested in, but a combination of variables does.  

\section{Geoms}
\label{sec:geom}


Geoms, or geometric elements, perform the actual rendering of the plot.

Geoms are also responsible for drawing legends, as explained in in Section~\ref{sec:legends_and_axes}.

Table~\ref{tbl:geoms} lists all of the geoms available in ggplot.  It also describes which aesthetics they understand, what parameters they take, if any.  The chief difference between aesthetics and parameters is that aesthetics can vary across observations, while parameters are fixed.  For individual geoms, more documentation is available in the documentation.  This section describes some of the broader categories of geoms: intervals in Section~\ref{sec:geom_interval}, lines in Section~\ref{sec:geom_abhvline}, aliased in Section~\ref{sec:geom_aliased}.

\begin{table}
  \begin{center}
  \begin{tabular}{lp{3in}}
      \toprule
      Name & Description \\
      \midrule
      abline       & Line, specified by slope and intercept                                       \\
      area         & Area plots                                                                   \\
      bar          & Bars, rectangles with bases on y-axis                                        \\
      blank        & Blank, draws nothing                                                         \\
      boxplot      & Box and whiskers plot                                                        \\
      contour      & Display contours of a 3d surface in 2d                                       \\
      crossbar     & Hollow bar with middle indicated by horizontal line                          \\
      density      & Display a smooth density estimate                                            \\
      density\_2d & Contours from a 2d density estimate                                          \\
      errorbar     & Error bars                                                                   \\
      histogram    & Histogram                                                                    \\
      hline        & Line, horizontal                                                             \\
      interval     & Base for all interval (range) geoms                                          \\
      jitter       & Points, jittered to reduce overplotting                                      \\
      line         & Connect observations, in ordered by x value                                  \\
      linerange    & An interval represented by a vertical line                                   \\
      path         & Connect observations, in original order                                      \\
      point        & Points, as for a scatterplot                                                 \\
      pointrange   & An interval represented by a vertical line, with a point in the middle       \\
      polygon      & Polygon, a filled path                                                       \\
      quantile     & Add quantile lines from a quantile regression                                \\
      ribbon       & Ribbons, y range with continuous x values                                    \\
      rug          & Marginal rug plots                                                           \\
      segment      & Single line segments                                                         \\
      smooth       & Add a smoothed condition mean.                                               \\
      step         & Connect observations by stairs                                               \\
      text         & Textual annotations                                                          \\
      tile         & Tile plot as densely as possible, assuming that every tile is the same size. \\
      vline        & Line, vertical                                                               \\
  
      \bottomrule
  \end{tabular}
  \end{center}
  \caption{Geoms in \ggplot}
  \label{tbl:geoms}
\end{table}


\section{Stat}
\label{sec:stat}

What do statistical transformations do?

What statistical transformations are available?

Naming convention.

Each stat generate a number of output variables that can be used in aesthetic mappings.  These can be used with {\tt ..} around them.  That identifies that the variable is not present in the original dataset, but is computed by the stat.

\begin{table}
  \begin{center}
  \begin{tabular}{lp{3in}}
    \toprule
    Name & Description \\
    \midrule
    bin          & Bin data                                                   \\
    boxplot      & Calculate components of box and whisker plot               \\
    contour      & Contours of 3d data                                        \\
    density      & Density estimation, 1D                                     \\
    density\_2d & Density estimation, 2D                                     \\
    function     & Superimpose a function                                     \\
    identity     & Don't transform data                                       \\
    qq           & Calculation for quantile-quantile plot                     \\
    quantile     & Continuous quantiles                                       \\
    smooth       & Add a smoother                                             \\
    spoke        & Convert angle and radius to xend and yend                  \\
    step         & Create stair steps                                         \\
    sum          & Sum unique values.  Useful for overplotting on scatterplots\\
    summary      & Summarise y values at every unique x                       \\
    unique       & Remove duplicates                                          \\
    \bottomrule
  \end{tabular}
  \end{center}
  \caption{Stats in \ggplot}
  \label{tbl:stats}
\end{table}


\section{Pulling it all together}
\label{sec:pull-together}

\subsection{Creating new plot types}
\label{sub:new_plot_types}

By connecting geoms with different statistics, you can easily create new types of graphics.  

Some of the geoms aren't really geoms in their own right, but are another geom with a few differences in the defaults.  These are called ``aliased'' geoms and created to represent common plot types that are a combination of ...  For example, the histogram, is just a combination of the bar geom, and the bin stat, but because it is used so commonly we want to give it is own name. Many of these geoms are used in a different manner to the base geom, and so the examples may be quite different, another reason for creating a separate geom.

\begin{table}
  \begin{center}
  \begin{tabular}{lll}
    \toprule
    Aliased geom & Base geom & Changes in default \\
    \midrule
    area      & ribbon & \verb!aes(min = 0, max = y), position = "stack"!  \\
    density   & area   & \verb!stat = "density"!    \\
    histogram & bar    & \verb!stat = "bin"!        \\
    jitter    & point  & \verb!position = "jitter"! \\
    quantile  & line   & \verb!stat = "quantile"!   \\
    smooth    & ribbon & \verb!stat = "smooth"!     \\
    \bottomrule
  \end{tabular}
  \end{center}
  \caption{Geoms that modify the defaults of another geom.}
  \label{label}
\end{table}

Violin plot example.

\subsection{Different data on different layers}
\label{sub:different_data_on_different_layers}

Example overlaying raw data and model predictions.


\input{_footer.tex}
