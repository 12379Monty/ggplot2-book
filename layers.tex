\input{_header.tex}

% decumar<<< 
% source("~/documents/ggplot/ggplot/load.r")
% library(xtable)
% doptions(width=8, height=4.8, lscale=0.5)
% ggopt(axis.color = "black")
% set.seed(1410)
% dsmall <- diamonds[sample(nrow(diamonds), 1000),]
% >>>

\chapter{Build a plot layer by layer}

\section{Introduction}

As alternative (or supplement) to \f{qplot}, you can manually build up a plot layer by layer.  A layer encapsulates all of the information needed to draw most normal plots:  the data, mapping from the data to aesthetic attributes that can be perceived, a way of representing the data, and an optional statistical transformation.  A first the statistical transformation may not seem like it belongs here - but many common plots incorporate some kind of statistical summary, for example, the histogram or adding a smoothed line to a plot.  

This chapter will describe:

\begin{itemize}
  \item What a layer is, how to create one using the full or shortcut syntaxes \S\ref{sec:layers}.

  \item More details about the data, \S\ref{sec:data}
\end{itemize}

To create 

Adding layers on to a plot requires that you have already created a plot object.  This could be created by \f{qplot} as described in Chapter~\ref{cha:qplot}, or by \f{ggplot} as described in Chapter~\ref{cha:mastery}.  The difference between the two is that the former is already a complete plot, you are just adding extras to it, while with \f{ggplot} you need to add layers before it can be rendered.  In practice, use whatever works for you - personally, I use whatever requires the least amount of typing.

Plots created in either manner are identical.  To see this look at the \f{qplot} code - it creates a plot with \f{ggplot}, then adds layers.  If you want to see in more detail how qplot syntax can be converted to ggplot, Appendix\ref{cha:translating} gives more details.

A typical graphic has three layers:

\begin{itemize}
  \item The {\bf data}.  This layer appears on every graphic and 

  \item A statistical {\bf summary}.  For the purposes of communication and inference, any conclusions we make about the data will typically be summarised and supported by a quantitative model.  Displaying the predictions from this model in the context of the data is useful to both summarise the data, and to detect potential problems with the model.  This is normally the top layer.

  \item {\bf Context}.  The context for the data shouldn't interfere with the perception of the data, so it should normally be on the bottom layer and formatted so that it is minimally perceptible.  That is, if you concentrate on it, you can see it with ease, but it doesn't jump out at you when you are casually browsing the plot.
  
  For spatial data, the context will often be a map.  For temporal data, it might be significant events outside the data.  Context can also include labelling unusual points.
\end{itemize}

This section describes the main components of each layer (data, aesthetic mappings, geoms and statistics), lists the different geoms and stats available in ggplot2 and ...



\section{Layers}
\label{sec:layers}

% What is a layer?

A layer is a combination of data, aesthetic mappings, geom, statistic and position adjustment.  There are two ways to create layers, an explicit method and a short-hand.  Most of the time 

You can create a layer with the {\tt layer()} function which has arguments geom, geom\_params, stat, stat\_params, position, data, and mapping.

However, most of the time, you will use a shortcut.  The shortcut is possible because associated with every geom is a default statistic and position, and with every statistic is a default geom.  This means that you only need to specify one of stat or geom to get a completely specified layer.

Geoms are described in more detail (including a list of all geoms available in ggplot) in Section~\ref{sec:geom}, and stats in Section~\ref{sec:stat}.  Position adjustments are described separately, with the other means of manipulating position within and between plots, in Section~\ref{sec:position}.

All layer functions start with {\tt geom\_} or {\tt stat\_} and are singular, eg. {\tt geom\_point}, {\tt stat\_bin}.  This convention is used through ggplot2: scales start with {\tt scale\_}, coordinate systems with {\tt coord\_}, and facet specifications with {\tt facet\_}.

All the layer functions have the same basic form:

\begin{alltt}
geom_XXX <- function(aesthetics, data, ..., geom, position) {}
stat_XXX <- function(aesthetics, data, ..., stat, position) {}
\end{alltt}

\noindent and they have common parameters, which describe the components of the layer:

\begin{itemize}
	\item The {\bf data} to use (optional).  If left out (as you will do most of the time), it will use the default data set that you specified when creating the plot.  

	\item Aesthetic {\bf mapping} (optional), specified by the {\tt aes()} function, described in Section~\ref{sec:aes}.  These are added on to the plot defaults.  If you want to remove want of the plot defaults, you'll need map the value to {\tt NULL}, e.g. {\tt aes(colour = NULL)}.
	
	\item For geoms, you can override the default {\tt stat}, and for stats the default {\tt geom}.  This should be a text string containing the name of the geom to use.  Using the default will give you a standard plot - if you want something more exotic, overriding the defaults gives you more freedom.  This is described in more detail in Section~\ref{sub:new_plot_types}.
	
	\item Any aesthetic that the geom recognises can also be specified as a parameter to the plot.  See Section~\ref{sub:setting-mapping}.

	\item Other parameters which differ from geom to geom, and stat to stat.  These parameters control various settings of the geom and statistic, for example, bin width in the histogram, or bandwidth for a loess smoother.  Any aesthetic can also be used as a parameter, in which case it will be applied to all points.
\end{itemize}

All parameters to the layer are optional.

The summary function can be helpful for inspecting the structure of a plot, without plotting it:

%WEAVE(include=TRUE)
%R p <- ggplot(data=mtcars, aes(mpg, wt))
%R summary(p)
%R p <- p + geom_point(p)
%R summary(p)

%END 

\begin{alltt}
p <- ggplot(data=mtcars, aes(mpg, wt))
summary(p)
p <- p + geom_point(p)
summary(p)
\end{alltt}

Note that the order of data and mapping is switched between {\tt ggplot()} and the layer functions.  This is for good reason - you almost always specify data for the plot, and almost always specify aesthetics (but not data) for the layers.  To keep your code readable, I suggest always explicitly naming other arguments.

\section{Data}
\label{sec:data}

Must be a data frame.
Is a copy not a reference.

If you use faceting on your plot, you must have a default dataset.  This is because faceting is a global operation (i.e. works on all layers) and it needs to have some base dataset to add in any missing columns.  See Section~\ref{sub:missing_faceting_columns} for more details.

\section{Aesthetic mapping}
\label{sec:aes}

To describe the way that variables in the data are mapped to things that we can perceive on the plot (the ``aesthetics''), we use the {\tt aes} function.  The {\tt aes} function takes a list of aesthetic-variable pairs as follows:

\begin{alltt}
aes(x = weight, y = height, colour = age)
\end{alltt}

Here we are mapping x-position to weight, y-position to height and colour to age.  Alternatively, the first two arguments can be left without names, in which case they are assumed to be for the x and y variables.  (This matches the way that {\tt qplot()} is normally used.)

\begin{alltt}
aes(weight, height, colour = age)
\end{alltt}

Things inside aes can be functions, but all variables must be contained inside the plot (or layer) data.  This is important because ggplot2 objects are entirely self-contained.  You can save one to disk and later plot it without needing anything else from that session.

The {\tt aes} function is usually used inside a layer, but it can also be added directly to the plot to override the previous (default) mappings.  

\begin{alltt}
(p <- qplot(mpg, wt, data=mtcars))
p + aes(wt, hp)
\end{alltt}

If you want to use the defaults you set up when creating the plot object, you just use the geom function like:

\begin{alltt}
p + geom_line()
\end{alltt}

This will create a new plot object with an addition layer that joins points with lines.  (To see how to control what sets of observations form a line, see Section~\ref{sec:grouping}) lines geom added to its list of geoms.   You can also add more aesthetics, or specify a different data set to use instead of the default.  

\begin{alltt}
p + geom_line(aes(colour=a, size=b), data=new.data.frame))
\end{alltt}

If there is a default aesthetic you want to unset, use {\tt NULL}:

\begin{alltt}
p + geom_line(p, aes(colour=NULL))
\end{alltt}

Table~\ref{tbl:aes-override} summarises these rules.

\begin{table}
  \begin{center}
  \begin{tabular}{lll}
    \toprule
    Default & Layer  & Result \\
    \midrule
    x = mpg, y = wt & colour = cyl & x = mpg, y = wt, colour = cyl \\
                    & y = disp & x = mpg, y = disp \\
                    & y = NULL & x = mpg \\
    \bottomrule
  \end{tabular}
  \end{center}
  \caption{Rules for combining layer aesthetic mapping with default mapping:  additional aesthetics are added, existing overridden, and {\tt NULL} removes.}
  \label{tbl:aes-override}
\end{table}

If the plot is facetted, and the new data set does not contain the faceting columns, then the data set will be duplicated for each value of the missing columns.  This has the effect of displaying the data in every facet.  This is explained in more detail, with examples, in chapter XXX, page X.

\subsection{Setting vs. mapping}
\label{sub:setting-mapping}

For every aesthetic the geom function understands, you can also set that aesthetic as an parameter to the function.  Remember, aesthetics can vary for each observation being plotted, while parameters are the same.  Instead of mapping data to that aesthetic, this will change the default.  For example:

\begin{alltt}
p + geom_line(colour="red")  
\end{alltt}

\noindent will set the line colour to be red instead of black.  Other examples:

\begin{alltt}
p + geom_line(size=3)  
p + geom_line(size=3, colour="blue")  
\end{alltt}

\begin{table}
  \begin{center}
  \begin{tabular}{lp{3in}}
    \toprule
    Aesthetic & Value \\
    \midrule
    Colour and fill & See the section ``Color Specification'' in {\tt ?par}.  A string in the format {\tt \#RRGGBB} or {\tt \#RRGGBBAA}, or an R colour name.  See {\tt ?colours()} for a complete list, and {\tt ?alpha()} for an easy way of making transparent colours. \\
    Position: x, y, z, min and max & A value that makes sense in the data space. \\ 
    Size & Numeric, measured in mm.\\
    Line type &  See the section ``Line Type Specification'' in {\tt ?par}\\
    Shape & See the section ``pch values'' in {\tt ?points()} \\
    Justification: hjust, vjust &  \\
    \bottomrule
  \end{tabular}
  \end{center}
  \caption{Acceptable values for setting aesthetics}
  \label{tbl:aesthetic-values}
\end{table}

With qplot, you can do the same thing by putting the value in {\tt I()}:

\begin{alltt}
  qplot(mpg, wt, data=mtcars, colour = "red")
  qplot(mpg, wt, data=mtcars, colour = I("red"))
\end{alltt}


\subsection{Grouping and weights}
\label{sub:grouping}

There are also two aesthetic attributes that can't be perceived directly.  The most important of these is the {\tt group} aesthetic, which divides the the data set into discrete components.   This is used in line and path plots to separate the data for different lines, and in the groups grob to divide the different groups. 

By default, the group aesthetic is set to the combination (interaction) of all discrete variables used in the plot.  Generally, this will create the correct separation of the data, but sometimes you will need to override it.  For example, if you want lines connecting observations with a discrete x scale you will need to manual specify the group aesthetic.  This section illustrates a few possible applications when this is useful.

The {\tt interaction()} function is particularly useful if there isn't a pre-existing variable that separates the groups you are interested in, but a combination of variables does.  

Examples.

The {\tt weight} aesthetic is also useful when you have weighted data.  All ggplot2 statistics know how to correctly deal with (WHAT TYPE OF WEIGHTS?) weights, which makes plotting your weighted data easy.  For a more comprehensive description of plotting weights, see ``Weight and see''.



\section{Geoms}
\label{sec:geom}


Geoms, or geometric elements, perform the actual rendering of the plot.

Geoms are also responsible for drawing legends, as explained in in Section~\ref{sec:legends_and_axes}.

Table~\ref{tbl:geoms} lists all of the geoms available in ggplot.  It also describes which aesthetics they understand, what parameters they take, if any.  The chief difference between aesthetics and parameters is that aesthetics can vary across observations, while parameters are fixed.  For individual geoms, more documentation is available in the documentation.  This section describes some of the broader categories of geoms: intervals in Section~\ref{sec:geom_interval}, lines in Section~\ref{sec:geom_abhvline}, aliased in Section~\ref{sec:geom_aliased}.

\begin{table}
  \begin{center}
  \begin{tabular}{lp{2.5in}p{2.5in}}
    \toprule
    Name & Description & Aesthetics + parameters \\
    \midrule
    abline       & Line, specified by slope and intercept                                        & colour, intercept, linetype, size, slope +                                           \\
    area         & Area plots                                                                    & colour, fill, linetype, max, max, min, min, size, x, y +                             \\
    bar          & Bars, rectangles with bases on y-axis                                         & colour, fill, linetype, max, max, min, min, size, x + width                          \\
    blank        & Blank, draws nothing                                                          &  +                                                                                   \\
    boxplot      & Box and whiskers plot                                                         & colour, fill, max, min, size, weight, x + outlier.colour, outlier.shape, outlier.size\\
    contour      & Display contours of a 3d surface in 2d                                        & colour, linetype, size, weight, x, y +                                               \\
    crossbar     & Hollow bar with middle indicated by horizontal line                           & colour, fill, linetype, max, max, min, min, size, width, x + fatten                  \\
    density      & Display a smooth density estimate                                             & colour, fill, linetype, max, max, min, min, size, weight, x, y +                     \\
    density\_2d & Contours from a 2d density estimate                                           & colour, linetype, size, weight, x, y +                                               \\
    errorbar     & Error bars                                                                    & colour, linetype, max, min, size, x + width                                          \\
    histogram    & Histogram                                                                     & colour, fill, linetype, max, max, min, min, size, x + width                          \\
    hline        & Line, horizontal                                                              & colour, linetype, size + intercept                                                   \\
    interval     & Base for all interval (range) geoms                                           & max, min, x +                                                                        \\
    jitter       & Points, jittered to reduce overplotting                                       & colour, fill, shape, size, x, y +                                                    \\
    line         & Connect observations, in ordered by x value                                   & colour, linetype, size, x, y +                                                       \\
    linerange    & An interval represented by a vertical line                                    & colour, linetype, max, min, size, x +                                                \\
    path         & Connect observations, in original order                                       & colour, linetype, size, x, y +                                                       \\
    point        & Points, as for a scatterplot                                                  & colour, fill, shape, size, x, y +                                                    \\
    pointrange   & An interval represented by a vertical line, with a point in the middle        & colour, linetype, max, min, shape, size, x +                                         \\
    polygon      & Polygon, a filled path                                                        & colour, fill, linetype, size, x, y +                                                 \\
    quantile     & Add quantile lines from a quantile regression                                 & colour, linetype, size, weight, x, y +                                               \\
    ribbon       & Ribbons, y range with continuous x values                                     & colour, fill, linetype, max, min, size, x +                                          \\
    rug          & Marginal rug plots                                                            & colour, linetype, size +                                                             \\
    segment      & Single line segments                                                          & colour, linetype, size, x, xend, y, yend + arrow                                     \\
    smooth       & Add a smoothed condition mean.                                                & alpha, colour, fill, linetype, size, weight, x, y +                                  \\
    step         & Connect observations by stairs                                                & colour, linetype, size, x, y +                                                       \\
    text         & Textual annotations                                                           & angle, colour, hjust, label, size, vjust, x, y +                                     \\
    tile         & Tile plot as densely as possible, assuming that every tile is the same size.  & colour, fill, height, linetype, size, size, width, x, y +                            \\
    vline        & Line, vertical                                                                & colour, intercept, linetype, size +                                                  \\
    \bottomrule
  \end{tabular}
  \end{center}
  \caption{Geoms available in ggplot2}
  \label{tbl:geoms}
\end{table}

\subsection{Interval geoms}
\label{sub:geom_interval}

Assume y conditioned on x.  Have additional position parameters, min and max, which determine the 

Continuous x: geom\_area, geom\_smooth.  Discrete x: linerange, pointrange, crossbar, 

\subsection{Annotation lines}
\label{sub:geom_abhvline}

abline, hline, vline

\subsection{Aliased geoms}
\label{sub:geom_aliased}

Some of the geoms aren't really geoms in their own right, but are another geom with a few differences in the defaults.  These are called ``aliased'' geoms and created to represent common plot types that are a combination of ...  For example, the histogram, is just a combination of the bar geom, and the bin stat, but because it is used so commonly we want to give it is own name. Many of these geoms are used in a different manner to the base geom, and so the examples may be quite different, another reason for creating a separate geom.

\begin{table}
  \begin{center}
  \begin{tabular}{lll}
    \toprule
    Aliased geom & Base geom & Changes in default \\
    \midrule
    area      & ribbon & \verb!aes(min = 0, max = y), position = "stack"!  \\
    density   & area   & \verb!stat = "density"!    \\
    histogram & bar    & \verb!stat = "bin"!        \\
    jitter    & point  & \verb!position = "jitter"! \\
    quantile  & line   & \verb!stat = "quantile"!   \\
    smooth    & ribbon & \verb!stat = "smooth"!     \\
    \bottomrule
  \end{tabular}
  \end{center}
  \caption{Geoms that modify the defaults of another geom.}
  \label{label}
\end{table}

\section{Stat}
\label{sec:stat}

What do statistical transformations do?

What statistical transformations are available?

Naming convention.

\begin{table}
  \begin{center}
  \begin{tabular}{lp{1.5in}p{2in}p{1in}p{1.5in}}
    \toprule
    Name & Description & Parameters & Input \newline aesthetics & Output \newline aesthetics \\
    \midrule
    bin          & Bin data                                                    & binwidth, breaks, origin, width                & x, y                            & count, density, ncount, ndensity     \\
    boxplot      & Calculate components of box and whisker plot                & coef, na.rm, width                             & x, y                            & lower, max, middle, min, upper, width\\
    contour      & Contours of 3d data                                         & na.rm                                          & group, x, y, z                  & level                                \\
    density      & Density estimation, 1D                                      & adjust, kernel, na.rm, trim                    & fill, x, y                      & count, density, scaled               \\
    density\_2d & Density estimation, 2D                                      & na.rm                                          & group, x, y                     & level                                \\
    function     & Superimpose a function                                      & args, fun, n                                   &                                 & x, y                                 \\
    identity     & Don't transform data                                        &                                                &                                 &                                      \\
    qq           & Calculation for quantile-quantile plot                      & distribution, na.rm, quantiles                 & sample, x, y                    & sample, theoretical                  \\
    quantile     & Continuous quantiles                                        & formula, method, na.rm, quantiles, xseq        & group, x, y                     & quantile                             \\
    smooth       & Add a smoother                                              & formula, fullrange, level, method, n, se, xseq & x, y                            & max, min, se, y                      \\
    spoke        & Convert angle and radius to xend and yend                   &                                                & angle, radius, x, xend, y, yend & xend, yend                           \\
    step         & Create stair steps                                          &                                                & x, y                            &                                      \\
    sum          & Sum unique values.  Useful for overplotting on scatterplots &                                                & size, x, y                      & prop, round\_any, sum               \\
    summary      & Summarise y values at every unique x                        & fun                                            & x, y                            &                                      \\
    unique       & Remove duplicates                                           &                                                &                                 &                                      \\
    \bottomrule
  \end{tabular}
  \end{center}
  \caption{caption}
  \label{label}
\end{table}


\subsection{Generated aesthetics}
\label{sub:generated_aesthetics}

Each stat generate a number of output variables that can be used in aesthetic mappings.  These can be used with {\tt ..} around them.  That identifies that the variable is not present in the original dataset, but is computed by the stat.

\subsection{Summary statistic}
\label{sub:summary_statistic}

\section{Pulling it all together}
\label{sec:pulling_it_all_together}

\subsection{Creating new plot types}
\label{sub:new_plot_types}

By connecting geoms with different statistics, you can easily create new types of graphics.  

Violin plot example.

\subsection{Different data on different layers}
\label{sub:different_data_on_different_layers}

Example overlaying raw data and model predictions.


\input{_footer.tex}
