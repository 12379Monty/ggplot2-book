\input{header.tex}

\setchapterpreamble[u]{% 
\dictum[Friedrich Nietzsche]{He who fights with monsters might take care lest he thereby become a monster. And if you gaze for long into an abyss, the abyss gazes also into you.}} 

\chapter{Using grid to modify ggplot graphics}

The options provided by {\tt ggplot} to customise your plot can only go so far.  This chapter describes how to use the power of grid graphics to delve into the dark depths of {\tt ggplot} and modify to your hearts content.  

Please remember that I've done my best to provide perceptually sensible defaults, and you should think carefully about what you are doing before you make any big changes.  Some particular good references are:

\begin{itemize}
	\item Cleveland's books and article in JASA
	\item Cynthia Brewer for area colours
	\item Tufte for aesthetics
	\item Bertin for maps
	\item Wilkinson in general
\end{itemize}

This chapter can not hope to provide a comprehensive introduction to grid, but should hopefully provide enough exam	ples that even if you have never used grid before you should be able to customise ggplot to meet your needs.  I highly recommend the book ``R Graphics'', by Paul Murrell, as a companion to this chapter, or if you are interested in learning more about grid.   

Rather confusingly, the ``grobs'' in this chapter are a bit different to grobs in previous chapters.  They refer to the low level grid grobs, which create the things that you actually see on screen.  A further difference is that ggplot grobs are only used for data related things, while grid grobs create absolutely everything on the plot, including titles and axes.

\section{Structure of a plot}\label{sec:structure_of_a_plot}

To annotate or edit the plot, you first need to figure out what you want to change, and what it is called.  If you are annotating plots, you will want the appropriate viewport.  If you are editing plots, you will want the appropriate grob.  This section gives a general overview of the structure of a plot, and describes useful commands for figuring out the structure of your particular plot.

All the grobs and viewports in {\tt ggplot} should have a sensible name.  If they don't have a name, or the name doesn't make sense, this is a bug, and should be reported.  Generally, grobs that perform the same purpose, but live in different parts of the graph, still have the same name so that you can edit all of them simultaneously.  

\subsection{Viewports}\label{sub:viewports}

The structure of viewports will vary slightly from plot to plot, depending on how axes are shared across facets.  The {\tt layout} viewport contains the meat of the plot: strip labels, axes and facetting panels.  Viewports have prefixes in the following list, then their x and y-coordinates separated by a ``\_''.

\begin{itemize}
  \item {\tt labels\_h}: horizontal strip labels
  \item {\tt labels\_v}: vertical strip labels
  \item {\tt axis\_h}: horizontal axes
  \item {\tt axis\_v}: vertical axes
  \item {\tt panel}: facetting panels
\end{itemize}

Examples:

\begin{itemize}
  \item {\tt panel\_1\_1}: the first panel in the top left
  \item {\tt axis\_h\_1\_4}: the fourth horizontal axis
  \item {\tt labels\_v\_3\_1}: the third vertical axis
\end{itemize}

Useful tools for this are the grid commands {\tt current.vpTree(all=TRUE)} and {\tt current.grobTree(all=TRUE)} which list the available viewports and grobs, respectively.  

\section{Controlling output}\label{sec:controlling_output}

By default, showing a {\tt ggplot} object at the R command prompt will display to the screen.  To exercise more control, you can call {\tt print} explicitly.  This section describes some of the things you can do.  For more details see {\tt ?print.ggplot} and {\tt ?ggplot\_print}.

If you just want the plot (no labels, titles or legends) you can use {\tt pretty = FALSE}

\begin{alltt}
p <- qplot(wt, mpg, data=mtcars, colour=cyl)
print(p, pretty = FALSE)
current.vpTree(all=TRUE)
\end{alltt}

If you want to write a plot function that customises how the plot is put together (ie. the arrangement of panels and guides) you need to provide different functions for {\tt viewports}, {\tt panels} and {\tt guides}.  If you are interested in doing this, I suggest you email me and talk over exactly what you want to do.

By default, {\tt ggplot} always clears the screen and draw to the entire device.  You can do this in two ways.  Firstly, you can setup a viewport and push it on to the display, then draw the plot with {\tt newpage=FALSE}:

\begin{alltt}
p <- qplot(wt, mpg, data=mtcars, colour=cyl)
grid.newpage()
pushViewport(viewport(height=0.5, width=0.5, x=0.2, y=0.2))
print(p, newpage=FALSE)
upViewport()
\end{alltt}

Alternatively, you can set up your own set of viewports, and then specify which one the plot should be drawn to.

\begin{alltt}
pushViewport(viewport(height=0.2, width=0.2, x=0.5, y=0.5, name="small", angle=90))
upViewport()
print(p, vp="small")
\end{alltt}

\subsection{Using {\tt grid.layout}}\label{sub:using_grid_layout}

Obviously, this is very useful if you want to layout plots in a complicated grid.  In this case, setup your grid using {\tt grid.layout} and then draw to it.

\begin{alltt}
p <- qplot(wt, mpg, data=mtcars, colour=cyl)
lay <- grid.layout(3,3)
vplayout <- function(x, y) 
  viewport(layout.pos.row=x, layout.pos.col=y)
grid.newpage()
pushViewport(viewport(layout=lay))
#pushViewport(vplayout(1,2:3)); print(p, newpage=FALSE); upViewport()

print(p, viewport=vplayout(1,1))
print(p, viewport=vplayout(2:3,2:3))
print(p, viewport=vplayout(1, 2:3))
print(p, viewport=vplayout(1:3, 3))
\end{alltt}

This is useful for arranging plots in a wider range of ways than what you can do with facetting.   You should be careful to ensure that scales are consistent over the different plots.  There is no easy way to do this, except to keep track of the maximum and minimum yourself, and then manually set the scales of the plot.

\begin{alltt}
	example of that here
\end{alltt}

As the above example shows, you will probably want to use {\tt print(p, pretty=false)} and manually add grobs and viewports to draw the labels yourself.
 
\section{Modifying stuff}\label{sec:modifying_stuff}

Before you try to manually edit the grobs, check to make sure that there isn't an option that already controls the appearance.  See section XXX, page X, for more details.  Most of the difficulty in modifying stuff on the plot is figuring out the name of the grid you want to modify.  Grobs that are likely to want to edit include:

\begin{itemize}
	\item Strips
	\item Labels
	\item Axes
	\item Background
\end{itemize}

To get a complete list of all grobs in the plot, remember to use {\tt current.grobTree(all=TRUE)}.  

Once you have the name of the grob you want to edit, use  {\tt grid.edit} to change the graphical parameters of the model.  Remember, that grid graphic parameters (gpar) have the same argument names as base R (eg. cex, pch, col) not {\tt ggplot} (eg. size, shape, colour).  You can find a complete list of graphical parameters in {\tt ?gpar}.

When you are modifying grobs that appear in multiple places, make sure to set {\tt global=TRUE} so that every grob is modified, not just the first one with that name.

In this example, we edit the font of the strip labels.

\begin{alltt}
example here
\end{alltt}

You can also use {\tt grid.remove} to completely remove a grob.

\begin{alltt}
example here
\end{alltt}

\section{Adding annotations}\label{sec:adding_annotation}

To add annotations to a plot you have to specify the viewport when you add extra grobs.  For example:

\begin{alltt}
p <- qplot(wt, mpg, data=mtcars, colour=cyl)
print(p, pretty=FALSE)
grid.circle(vp="layout::panel_1_1")
\end{alltt}

Panel viewports will have a coordinate system set up for points, while x- and y- axes will only have one dimension defined.  For example, on the x-axis there will be native coordinates for the x-dimension, but not the y-dimension.

\begin{alltt}
p <- qplot(wt, mpg, data=mtcars, colour=cyl)
print(p, pretty=FALSE)
grid.lines(x=unit(c(0,1), "npc"), y=unit(23, "native"), vp="layout::panel_1_1")
grid.lines(x=unit(c(0,1), "npc"), y=unit(23, "native"), vp="layout::axis_v_1_1")
\end{alltt}

Draw a line across the whole plot is a bit trickier: you need find a viewport with the correct coordinate system, convert the measurement to a global coordinates and then draw using those coordinates.

\begin{alltt}
print(p, pretty=FALSE)
\end{alltt}

Alternatively, if you only want to draw lines, not place other grobs, you can use {\tt move.to} and {\tt line.to}.  See their help pages for more detail.

\begin{alltt}
example here
\end{alltt}

One other thing you may want to do when adding annotations is make the viewport bigger.  For example, if you are adding big labels on to the x-axis, there might not be enough space on the plot to display them.  

\begin{alltt}
example here
\end{alltt}

Remember you can use {\tt current.vpTree(all=TRUE)} to remind you of what viewports are available to draw in.

\section{Layouts}\label{sec:layouts} % (fold)

ibrary(ggplot)
library(grid)

grid.newpage()
pushViewport(viewport(layout=grid.layout(1, 2)))

print(qplot(wt, mpg, data=mtcars), vp=viewport(layout.pos.col=1, layout.pos.row=1))
print(qplot(vs, mpg, data=mtcars), vp=viewport(layout.pos.col=2, layout.pos.row=1))


% section layouts (end)

\input{footer.tex}
