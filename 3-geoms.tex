\input{header.tex}

\chapter{Geometric objects}


% \subsection{Graphical objects}\label{sub:graphical_objects}
% 
% Once you have set up the defaults, you will want to add graphical objects to the plot.  There is a separate function for each type of graphical object, but they all have a very similar structure.  All of the geom functions start with {\tt geom_}.  Chapter XXX lists all of the geom functions, and explains in detail their function and options that they take.  There is also a list of all geoms in {\tt ?geom_plot}, which will also contain any added since this book was printed.
% 
% If you want to use the defaults you set up when creating the plot object, , you just use the geom function like:
% 
% \begin{alltt}
% p + geom_line()
% \end{alltt}
% 
% This will create a new plot object with a lines geom added to its list of geoms.  By default, this object will be plotted, so that you see the effect of the geom function immediatly.  You can also add more aesthetics, or specify a different data set to use instead of the default.  
% 
% \begin{alltt}
% p + geom_line(aes(colour=a, size=b), data=new.data.frame))
% \end{alltt}
% 
% If there is a default aesthetic you want to unset, use {\tt NULL}:
% 
% \begin{alltt}
% p + geom_line(p, aes(colour=NULL))
% \end{alltt}
% 
% If the plot is facetted, and the new data set does not contain the facetting columns, then the data set will be duplicated for each value of the missing columns.  This has the effect of displaying the data in every facet.  This is explained in more detail, with examples, in chapter XXX, page X.
% 
% For every aesthetic the geom function understands, you can also supply that aesthetic as an option to the function.  Instead of mapping data to that aesthetic, this will change the default.  For example.
% 
% \begin{alltt}
% p + geom_line(colour="red")  
% \end{alltt}
% 
% \noindent will set the line colour to be red instead of black.  Other examples:
% 
% \begin{alltt}
% p + geom_line(size=3)  
% p + geom_line(size=3, colour="blue")  
% \end{alltt}
% 
% These changes to the aesthetic attributes will not appear in the legend.  If you do want to   manually set the aesthetic attributes, you can use a scale specially design to do that, {\tt scmanual}.  This scale provides a number of options that you can use to customise the legend.  See page XXX for more details.
% 


\section{Introduction}\label{sec:introduction}

Graphical objects, or geoms for short, are a key feature of {\tt geom_plot}.  Geoms create visual objects on the plot that allow you to see you data.  By choosing various types of geoms, you can recreate common plots.  For example, the {\tt geom_point} geom will make a scatterplot, and the {\tt geom_line} geom will create a line plot.  The advantage of the geom based system is that you can easily combine different geoms to create almost any plot that you can think of.  This section describes geom functions in detail, including what geoms are currently available in {\tt geom_plot} and how you can go about creating your own.


\section{Details}\label{sec:details}

All geom functions start with {\tt geom} and are singular, eg. \geomref{geom_point}, \geomref{geom_errorbar}.  They all have the following basic form:

\begin{alltt}
geom_XXX <- function(plot, aesthetics, data, ...) {}
\end{alltt}

\noindent and they take three types of input:

\begin{itemize}
	\item Plot and data settings: {\tt plot}, the plot to add the geoms to. If not specified, this will use the ``current'' plot, i.e. the plot which was last modified. Note that this can differ from the plot currently displayed on screen.  {\tt data} (optional), a data set to get the data from
	\item Aesthetic mappings: {\tt aesthetics} (optional), a list describing which variables should be mapped to which aesthetics.  If not specified, these will be drawn from the defaults in the plot object
	\item Other parameters which differ from geom to geom.  These parameters control various settings of the geom, for example, bin width in the histogram, or bandwidth for a loess smoother.  Any aesthetic can also be used as a parameter, in which case it will be applied to all points.
\end{itemize}

Geom functions add geoms to a plot object, as you can see in the following example.

\begin{alltt}
p <- geom_plot(data=mtcars, aes=list(x=mpg, y=wt))
str(p$geoms) 
str(geom_point(p)$geoms)
str(p$geoms)
p <- geom_point(p)
str(p$geoms)
\end{alltt}

\section{Categories}\label{sec:categories}

This section indexes geoms based on the tasks for which you might use them: 

\begin{itemize}
	\item Basic plot types
	\item For displaying distributions
	\item Dealing with overplotting
	\item ``3d'' plots
	\item Revealing uncertainty
	\item Annotating a plot
	\item Grouping
\end{itemize}


\subsection{Basics}\label{sub:basics}

These geoms are the basic geoms used to build up almost all of the other geoms.  These are useful for creating basic graphics, and when building your own geom function (see section \ref{sec:writing_your_own}).

\begin{itemize}
  \item \geomref{geom_point}: points
  \item \geomref{geom_line}, \geomref{geom_path}: paths and lines.  Lines are paths that have their x-axis values ordered in increasing value.
  \item \geomref{geom_polygon}: polygons
  \item \geomref{geom_bar}: bars
  \item \geomref{geom_text}: text
  \item \geomref{geom_tile}: tiles, rectangles which form a regular tessellation of the plane
\end{itemize}

\subsection{Displaying distributions}\label{sec:distributions}

There are quite a few geoms associated with displaying distributions:

\begin{itemize}
	\item \geomref{geom_boxplot}: box and whisker plot, for a continuous variable possibly conditioned by a categorical variable
	\item \geomref{geom_jitter}: a crude way of investigating densities
	\item \geomref{geom_quantile}: quantiles, for a continuous variable conditional on another continuous variable.
	\item \geomref{geom_density}: 
	\item \geomref{geom_histogram}: 
	\item \geomref{geom_2ddensity}: for displaying the density of points on the plot surface.
\end{itemize}

(Ask Heike about this)

We have a number of plots available to investigate distributions, depending on the number of variables, and whether we are interested in the conditional or joint distribution.

Single variable
+ cont: histogram, density plot, boxplot
+ cat:  barchart

Two variables: conditional
+ cat  | cat:  mosaic plot
+ cat  | cont: ?
+ cont | cont: quantiles
+ cat  | cont: boxplot

Two variables: joint
+ cat  * cat:  fluctuation diagram
+ cat  * cont: boxplots?
+ cont * cont: bagplot, geom_2ddensity

Jittered points can be used for any joint distribution (or conditional if one or both variables are categorical)

\subsection{Dealing with overplotting}\label{sec:overplotting}

The simplest way to deal with overplotting is to bin the plot into small squares and count the number of points that lies in each square, much like a 2D histogram.  This count can then be visualised as the third variable on a plot.  However, breaking the plot into many small squares produces distracting visual artefacts.  Carr (reference) sugeom_ests using hexagons instead, and this is implemented with \geomref{geom_hexagon}, using the capabilities of the {\tt hexbin package}.

A continuous analogue of this is to compute a 2D density function and then visualise this as coloured tiles or contour lines.  This can be done with \geomref{geom_2ddensity}.

Another approach to dealing with overplotting is to add supplemental information to help guide the eye to the true shape of or pattern within the data:

\begin{itemize}
	\item \geomref{geom_smooth} add a smooth line showing the mean.
	\item \geomref{geom_quantile} add a smooth line showing any quantile you are interested in.
\end{itemize}

\subsection{``3d'' plots}\label{sub:_3d_plots}

{\tt geom_plot} currently does not support true 3D plots.  However, it does offer two tools for producing pseudo-3d plots, the imageplot and the contour plot.

\begin{itemize}
	\item \geomref{geom_tile}: map z variable to fill colour
	\item \geomref{geom_contour}: useful for smoother surfaces
	\item \geomref{geom_point}: can map abs(z) variable to size and sign(z) to colour
\end{itemize}

These are often better than ``true'' 3d for static plots anyway, because many perceptual cues necessary for accurate depth perception (eg. occlusion, parallax) are not present in static plots.  You can also manually project data points in a higher dimensional space by multiplying by a projection matrix.  However, correctly representing occlusion or generating correct perspective effects will require considerably more effort.  You may want to look at RGL (\url{http://www.rgl.com}) and rggobi (\url{http://www.ggobi.org/ggobi}) for other solutions.

\subsection{Revealing uncertainty}\label{sub:displaying_uncertainty}

If you have information about the uncertainty present in your data, possibly from a model or distributional assumptions, it is often useful to visualise.  There are two geoms that allow you to do this depending on whether you have point or functional confidence intervals:

\begin{itemize}
	\item \geomref{geom_errorbar}: for pointwise confidence intervals
	\item \geomref{geom_ribbon}: ribbons of variable width, useful for displaying confidence intervals around functions
\end{itemize}

\subsection{Annotating a plot}\label{sub:annotating_a_plot}

Any of the basic geoms can be used to annotate a plot with additional output, for example, adding text with \geomref{geom_text}, or a point illustrating the mean with \geomref{geom_point}.  Additionally, there are several geoms whose use is almost entirely for annotation.  These are:

\begin{itemize}
	\item \geomref{geom_vline}, \geomref{geom_hline}: add vertical or horizontal lines to a plot
	\item \geomref{geom_abline}: add lines with arbitrary slope and intercept to a plot
\end{itemize}

See also \secref{sec:adding_annotation} for ways to add more general types of annotation using grid graphics.

\subsection{Grouping}\label{sub:grouping}

There is one special geom function that does not do any drawing of its own, but makes it possible to split up other geoms to display separate subsets within a plot.  This is \geomref{geom_group}.  This is equivalent to the {\tt lattice} {\tt group} argument, except that it works with all types of geoms.  

% \section{In detail}\label{sec:in_detail}
% 
% In the following sections I describe each of the geom functions available in {\tt geom_plot}, what it does and how it might be used in a practical situation.  These are arranged in alphabetical order.
% 
% \subsection{geom_2ddensity}\label{sub:geom_2ddensity}
% \subsection{geom_abline}\label{sub:geom_abline}
% \subsection{geom_bar}\label{sub:geom_bar}
% \subsection{geom_boxplot}\label{sub:geom_boxplot}
% \subsection{geom_contour}\label{sub:geom_contour}
% \subsection{geom_density}\label{sub:geom_density}
% \subsection{geom_errorbar}\label{sub:geom_errorbar}
% \subsection{geom_hexagon}\label{sub:geom_hexagon}
% \subsection{geom_histogram}\label{sub:geom_histogram}
% \subsection{geom_hline}\label{sub:geom_hline}
% \subsection{geom_jitter}\label{sub:geom_jitter}
% \subsection{geom_line}\label{sub:geom_line}
% \subsection{geom_path}\label{sub:geom_path}
% \subsection{geom_point}\label{sub:geom_point}
% \subsection{geom_polygon}\label{sub:geom_polygon}
% \subsection{geom_quantile}\label{sub:geom_quantile}
% \subsection{geom_ribbon}\label{sub:geom_ribbon}
% \subsection{geom_smooth}\label{sub:geom_smooth}
% \subsection{geom_text}\label{sub:geom_text}
% \subsection{geom_tile}\label{sub:geom_tile}
% \subsection{geom_vline}\label{sub:geom_vline}


\section{Writing your own}\label{sec:writing_your_own}

If a geom function (or a combination of geoms) does not meet your needs, it may be necessary to create your own geom function.  

As you use \texttt{geom_plot} more, you may discover some of the limitations of the included geom functions and want to write your own.  (Although I'm very open to sugeom_estions and if you develop a useful geom function I will be happy to include in the main package).  This document will discuss in detail how geom functions work and what you need to do to build your own.  As an example I will work through the process of creating a geom function that produces a 1d density plot with jittered rug plot, not unlike that created by \texttt{densityplot} in \texttt{lattice}.

\texttt{geom_plot} uses grid graphics, so to be able to create new geom functions you will need some familiarity with basic grid functions.  This isn't too hard to acquire, and I sugeom_est you look at the code for the basic geom functions (eg. \texttt{geom\_points}, \texttt{geom\_rect}) for some simple examples.

There are three functions you will need to write when creating a new geom function:

\begin{itemize}
	\item A convenient function for adding your geom function to a plot.  This is what the users uses to add the geom to the plot.  This provides a convenient place to modify other plot settings (eg. scales) that your geom might need.  See \texttt{geom_histogram} and \texttt{geom_point} for examples.
	\item The geom function.  This converts a list of aesthetics, plus some optional parameters to a gList of geoms.  This function is prefixed with \texttt{geom\_}.  
	\item The preprocessor function (optional).  If your geom function creates new aesthetics (like the densityplot will, by creating a new y position aesthetic) you will need this preprocessing stage so that the new aesthetics are available for the scale functions.  This function is prefixed with \texttt{pre\_}
\end{itemize}

\subsection{Example}\label{sub:example}

In this example, we're going to develop a geom function to display a 1d density with jittered geom plot.  We first need to decide what aesthetics and what optional parameters this function will take.  We want to give the user some flexibility over the how the density is computed, and the appearance of the density plot.  So let's use the following option parameters:

\begin{itemize}
	\item adjust: adjustment to default bandwidth
	\item kernel: type of kernel to use
	\item colour: the colour of the density line
\end{itemize}

There is only one aesthetic we need: $x$.  From this we will compute the density and create a y aesthetic.  We do this in the \texttt{pre\_density} function.  Remember that this function returns a data frame that will be used by scales, and then by \texttt{geom\_density}

\begin{verbatim}
pre_density <- function(data, adjust=1, kernel="gaussian", ...) {
   dens <- density(data$x, adjust=adjust, kernel=kernel)
   dens$'.type' <- "density"

   rug <- data.frame(x = jitter(data$x), y=-0.5, .type="rug")
   rbind(as.data.frame(dens[c("x","y",".type")]), rug)
}
\end{verbatim}

We can only return one data frame, so we need to package up the data for both the density and rug somehow.  I've chosen to do this by adding an extra column to the data frame called \texttt{.type} (so named to avoid conflict with user variables) that we will use to determine where the data should go.

The next task is to write geom function to draw the density (with lines) and the jittered rug plot (if necessary).

\begin{verbatim}
geom_density <- function(aesthetics, colour="black", ...) {
   aesthetics <- data.frame(aesthetics)
   dens <- subset(aesthetics, .type == "density")
   rug <- subset(aesthetics, .type == "rug")

   dens$colour <- colour

   gTree(children = gList(
      geom_line(dens),
      geom_rect(rug, colour="black")
   ))

}
\end{verbatim}

Finally, we write a convenience function to make it easy to for users.  This function also changes the y label to density, and sets up an appropriate scale.

\begin{verbatim}
geom_density <- function(plot = .PLOT, aesthetics=list(), ..., data=plot$data) {
   plot$ylabel <- "Density"
   plot <- pscontinuous(plot, "y", range=c(0,NA), expand=c(0.05,0))
   geom__add("density", plot, aesthetics, ..., data=data)
}  
\end{verbatim}


\input{footer.tex}
