\input{_header.tex}

\chapter{Strategies for using ggplot2 effectively}
\label{cha:strategy}

\section{Introduction}

An important component of doing a data analysis is flexibility.  If the data changes, or you discover something that makes you rethink your basic assumptions, you need to be able to easily change all of the plots that you have produced.  \ggplot has been designed with this flexibility in mind, and this section discusses some of the ways you can use \ggplot to be as flexible as possible.

One of the main components that inhibits flexibility is duplication. If you have the same basic plot components repeated over and over again, you have to make the same change in many different places.  Just the thought of having to do that can be prohibitive!  In programming practice this is codified as {\bf Do not repeat yourself}: whenever, possible avoid duplication.

This section discusses the following strategies that will speed up your use of \ggplot:

\begin{itemize}
  \item Building plots iteratively by modifying the ``last'' plot, \secref{sec:iteration}.

  \item Creating ``templates'' with lists of ggplot objects, \secref{sec:templates}.

  \item Writing functions that build plots or modify existing plots, \secref{sec:functions}.

  \item Writing \f{ggplot} methods for objects other than data frames, \secref{sec:methods}.

  \item Working with molten data, \secref{sec:reshape}.

\end{itemize}

\section{Iteration}
\label{sec:iteration}

Whenever you create or modify a plot, \ggplot saves a copy of the result so you can refer to it in later expressions.  You can access this plot with \f{last_plot()}.  This is useful for interactive use as you can start with a basic plot and then iteratively add layers, improving it as you go.

This is most useful for tweaking the scales or coordinate systems, as you can only add new layers, not remove existing layers, or modify their parameters.  For example, if you are experimenting with what x and y axis limits give the best view of your data, using \f{last_plot} in conjunction with \f{xlim} and \f{ylim} (Section~\ref{sec:position_scales}) can save you a lot of typing.  

\section{Plot templates}
\label{sec:templates}

Each component of a \ggplot plot is its own object and can be created, stored and applied independently of a plot.  This makes it easy to create reusable components that can automate common tasks.  This helps to offset the long functions names tend to be long but explicit.  The amount of typing that this creates can be offset by the ease of creating aliases.

The following example creates two continuous scales that can be used to turn off the display of axis labels and ticks.  You only need to create these objects once and you can apply them to many different plots.

% LISTING
% 
% xquiet <- scale_x_continuous("", breaks = NA)
% yquiet <- scale_y_continuous("", breaks = NA)
% quiet <- list(xquiet, yquiet)

You can combine multiple plot component into a list.  Adding the list to a plot is equivalent to adding each component of the list to the plot in turn.

Similarly, because all of the object are created by functions, you can easily wrap these functions within other functions that change the defaults.  For example, if you wanted to create a function that added linear models to a plot, you could create a function like the one below.

% INTERWEAVE
% 
% geom_lm <- function(formula, se = TRUE, ...) {
%   geom_smooth(formula = formula, se = se, ...)
% }
% qplot(mpg, wt, data = mtcars) + geom_lm(y ~ x)
% qplot(mpg, wt, data = mtcars) + geom_lm(y ~ ns(x, 3))

The next section discuss some of the issues that you might encounter when writing functions that create entire plots, not just components.

\section{Functions that create plots}
\label{sec:functions}

Sometimes you can't achieve the desired degree of control just by adding predefined layers.  Maybe you need to perform some data restructuring or transformation, or need to combine the data with a predefined model.  In that case you will need to write a function that produces \ggplot plots.  This section offers some advice on how to construct such a function in a way that is consistent with the philosophy of \ggplot, and ensures that it can be used flexibly and creatively.

Need to make some decisions.  How much flexibility does the function require.  This depends a lot on your audience - if it's just for you then you can make relatively inflexible and then just add capabilities as you need them, but if it's for a wider audience, more thought at the start will save time in the long run.

What parameters should your function take?

Format of the data.

Generating aesthetic mappings programmatically with \f{aes_string}, and combining with user supplied aesthetics.

Use example from one of the built in templates.  Maybe parallel coordinates.

\section{\f{ggplot} methods}
\label{sec:methods}

\f{ggplot} plot is a generic function, with dispatch on the data argument.  You can use this to enhance \f{ggplot} to work with other types of R objects apart from data frames.  This section outlines an approach you can use to create plot methods that are aligned with the rest of \ggplot philosophy.

The fundamental idea that underlies much of \ggplot is that data transformation and display should be kept as separate as possible.  This maximises reusability, as you are no longer trapped into the single display that the author envisaged.  Take the \f{plot} method for \code{lm} objects as an example.  There are many cases where you would like to take these plots as a starting point for your own work, but there is no way to reuse the function because data transformation and display are inextricably entangled.

A \ggplot version of that function might look something like this:

% Set of functions that each pull out the data in way that each 
% case of plot.lm does.  Some way of producing the default plots, but
% also being able to turn them off so you can just use the data.

\section{Working with molten data}
\label{sec:reshape}

A useful tool for getting data into the right shape to plot.  See the reshape documentation for more details, especially the introductory pdf.  The ``molten'' form can be useful in conjunction with {\tt ggplot} if your variables are all on the same scale, as you can plot many of the variables at once using line geoms and the {\tt group} attribute.  This is similar to what the parallel coordinates plot does.

Here is a basic introduction and some examples particularly relevant for {\tt ggplot}.

% INTERWEAVE
% 
% df <- data.frame(
%   time = 1:10, 
%   a    = 1:10, 
%   b    = rnorm(10), 
%   c    = (1:10)^2 / 10, 
%   d    = sin(1:10 * pi/2)
% )
% 
% dfm <- melt(df, id="time")
% head(dfm)
% qplot(time, value, data=dfm, ~ variable, type="line")


\input{_footer.tex}
