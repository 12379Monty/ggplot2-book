\input{_header.tex}

% qplot chapter suggestions:
% 
% * exercises - see plot and then try and create on your own
% * wall chart of different plot types
% * more error bar and ribbon examples
% * table of options

% SET_DEFAULTS
%   GG-WIDTH: 8  GG-HEIGHT: 4.8
%   TEX-WIDTH: 0.5\textwidth
%   INLINE: FALSE
%
% set.seed(1410)
% dsmall <- diamonds[sample(nrow(diamonds), 1000),]

% END

\chapter{Getting started with ggplot: {\tt qplot}}
\label{cha:qplot}

\section{Introduction} 

In this chapter, you will learn to make a wide variety of plots with your first ggplot function, {\tt qplot}, short for {\bf q}uick plot. qplot makes it easy to produce complex plots, often requiring several lines of code using other plotting systems, in one line. qplot can do this because it's based on the grammar of graphics, which allows you to create a simple, yet expressive, description of the plot.  In later chapters you'll learn to use all of the expressive power of the grammar, but here we'll start simple so you can work your way up.  You will also start to learn some of the ggplot terminology that will be used throughout the book.

{\tt qplot} has been designed be very similar to {\tt plot}, which should make it easy if you're already familiar with plotting in R.  Remember, during an R session you can get a summary of all the arguments to {\tt qplot} with R help, {\tt ?qplot}.

In this chapter you'll learn:

\begin{itemize}
	\item The basic use of {\tt qplot}---If you're already familiar with {\tt plot}, this will be particularly easy, \secref{sec:basic_use}.
	\item How to map variables to aesthetic attributes, like colour, size and shape, \secref{sec:aesthetic_attributes}.
	\item How to create many different types of plots by specifying different geoms, and how to combine multiple types in a single plot. Page \secref{sec:plot_geoms}.
	\item The use of faceting, also known as trellising or conditioning, to break apart subsets of your data, \secref{sec:faceting}.
	\item How to tune the appearance of the plot by specifying some basic options, \secref{sec:other_options}.
	\item A few important differences between {\tt plot} and {\tt plot}, \secref{sec:plot_diffs}
\end{itemize}

\section{Data sets}\label{sec:data_sets}

In this chapter we'll just use one data source, so you can get familiar with the plotting details rather than having to familiarise yourself with different datasets.  The {\tt diamonds} dataset consists of prices and quality information about 54,000 diamonds, and is included in the ggplot package.  The dataset has not been well cleaned, so as well as demonstrating interesting relationships about diamonds, it also demonstrates some data quality problems.  We'll also use another dataset, {\tt dsmall}, which is a random sample of 1000 diamonds.  We'll use this for plots which are more appropriate for smaller datasets.

The first few rows of the data are shown in \ref{tab:diamonds}.

% decumar<<< 
% xtable(head(diamonds), digits=c(0,1,2,0,1,1,1,0,2,2,2), align="l|rrrrrrrrrr", label="tab:diamonds", caption="{\\tt diamonds} dataset")
% |||
% latex table generated in R 2.5.1 by xtable 1.5-1 package
% Fri Aug 31 13:09:07 2007
\begin{table}[ht]
\begin{center}
\begin{tabular}{l|rrrrrrrrrr}
  \hline
 & carat & cut & color & clarity & depth & table & price & x & y & z \\
  \hline
1 & 0.2 & Ideal & E & SI2 & 61.5 & 55.0 & 326 & 3.95 & 3.98 & 2.43 \\
  2 & 0.2 & Premium & E & SI1 & 59.8 & 61.0 & 326 & 3.89 & 3.84 & 2.31 \\
  3 & 0.2 & Good & E & VS1 & 56.9 & 65.0 & 327 & 4.05 & 4.07 & 2.31 \\
  4 & 0.3 & Premium & I & VS2 & 62.4 & 58.0 & 334 & 4.20 & 4.23 & 2.63 \\
  5 & 0.3 & Good & J & SI2 & 63.3 & 58.0 & 335 & 4.34 & 4.35 & 2.75 \\
  6 & 0.2 & Very Good & J & VVS2 & 62.8 & 57.0 & 336 & 3.94 & 3.96 & 2.48 \\
   \hline
\end{tabular}
\caption{{\tt diamonds} dataset}
\label{tab:diamonds}
\end{center}
\end{table}
% >>>

\section{Basic use}\label{sec:basic_use}

Just like {\tt plot}, the first two arguments to {\tt qplot} are {\tt x} and {\tt y}, giving the x- and y-coordinates for the objects on the plot. 

There is also an optional {\tt data} argument.  If this is specified, {\tt qplot} will look inside that data frame before looking for objects in your workspace.  I recommend that you keep all the data for one plot in a data frame, instead of scattered across multiple vectors.  If {\tt data} is omitted, the {\tt qplot()} will attempt to generate a data frame from the variables .  Unfortunately this isn't 100\% accurate and sometimes {\tt qplot()} will have difficulties.  If this happens, supply an explicit data frame.

Here is a simple example of using {\tt qplot}, investigating the relationship between price and carats (weight) of a diamond.  

% INTERWEAVE
% 
% qplot(carat, price, data=diamonds)


You are not limited to specifying names of existing vectors: you can use functions of them as well.  Here we look at the relationship of log(price) to log(weight), and the relationship between weight and volume ($x * y * z$).

% INTERWEAVE
% 
% qplot(log(carat), log(price), data=diamonds)
% qplot(carat, x * y * z, data=diamonds)

These plots illustrate some unusual features of this dataset.  There seems to be a narrow band of prices for which there are no diamonds, and there are some diamonds with very unusual volumes for their weight.  We will investigate these relationships more as we continue.

\section{Aesthetic attributes}\label{sec:aesthetic_attributes}

The first big difference with using {\tt qplot} compared to {\tt plot} comes when you want to assign colours---or sizes or shapes---to the points on your plot.  With {\tt plot}, it's your responsibility to change your data (eg. ``apples'', ``bananas'', ``pears'') into something that {\tt plot} knows how to use (eg. ``red'', ``yellow'', ``green'').  {\tt qplot} will do this for you automatically, and will automatically provide a legend to make it easier to look up the actual data values.  This makes it easy to include additional data on the plot.  

In the next example, we augment the plot of carat and price with information about colour, clarity and cut of the diamonds.

% INTERWEAVE
% 
% dsmall <- diamonds[sample(nrow(diamonds), 1000),]
% qplot(carat, price, data=dsmall, colour=color)
% qplot(carat, price, data=dsmall, size=clarity)
% qplot(carat, price, data=dsmall, shape=cut)


Colour, size and shape are all examples of aesthetic attributes.  An aesthetic attribute is some property that affects how the observations are displayed.  For every aesthetic attribute, there is some function, called a scale, which maps data values to valid values for that aesthetic.  It is this scale that controls how the points appear.  For example, in the above plots, the colour scale maps J to purple and F to green.  We will learn how to configure this in Chapter X.  Note that while I use British spelling through this book, color will also work.

Different types of aesthetic attributes work better with different types of variables.  For example, colour and shape work well with categorical variables, while size works better with continuous variables.  You can always convert a continuous variable to a categorical one using the {\tt chop} function. The amount of data also makes a difference:  size works poorly when you have a lot of data, because you can't distinguish the individual points.  These issues are discussed more in chapter X.

\section{Plot geoms}\label{sec:plot_geoms}

{\tt qplot} is not limited to just producing scatterplots.  In fact, it can produce almost any type of plots, by varying the {\bf geom} used. Geom, short for geometric object, describes the type of object that is used to display the data.  Some geoms have an associated statistical transformation, for example, a histogram is a binning statistic plus a bar geom.  These different components are described in the next chapter.  Here we'll introduce you to the most common and useful geoms, categorised by whether they are useful for 1D or 2D data.

Other tools described in Chapter~\ref{cha:toolbox}.

The following geoms enable you to investigate 2D relationships:

\begin{itemize}
	\item {\tt geom="point"} draws points to produce a scatterplot (the default), as described above.
	\item {\tt geom="smooth"} fits a smoother to the data and displays the smooth and its standard error.
	\item {\tt geom="quantile"} displays conditional density estimates.  You can think of this as a extension of boxplots to deal with the case of a continuous conditioning variable.
	\item {\tt geom="density2d"} adds contours of a 2d density estimate.  This is very useful when you have a lot of overplotting.
	\item {\tt geom="path"} and {\tt geom="line"} draw lines between the data points.  Traditionally these are used to explore relationships between time and another variable, but lines may to be use to join observations connected in some other way.  A line plot is constrained to produce lines that travel from left to right, while paths can go in any direction.
	\item {\tt geom="boxplot"} produces a box and whisker plot to summarise the distribution of a set of points.
\end{itemize}

These geoms are useful for exploring 1d distributions:

\begin{itemize}
	\item {\tt geom="histogram"} draws a histogram of the $x$ variable 
	\item {\tt geom="density"} creates a density plot for the $x$ variable (only works for continuous variables)
  \item {\tt geom="bar"} makes a barchart.
\end{itemize}

% Other types of plots for dealing with categorical data (bar charts, mosaic plots, spineplots, spinograms) are dealt with in chapter X, using the special categorical plotting function {\tt catplot}.



\subsection{Adding a smoother to a plot}\label{sub:smooth}

If you have a scatterplot with many data points, it can be hard to see exactly what trend is shown by the data.  In this case you may want to add a smoothed line to the plot.  This is easily done using the {\tt smooth} geom:

% INTERWEAVE
% 
% qplot(carat, price, data=dsmall, geom=c("smooth", "point"))
\input{_include/12b23389cdf1af28febc480526614634.tex}
% END

Notice that we have combined multiple geoms by supplying a vector of geom names to {\tt qplot}.  The geoms will be overlaid in the order that you specified them.

There are many different smoothers you can choose using the {\tt method} argument:

\begin{itemize}
	\item {\tt method="loess"}, the default, uses a smooth local regression.  More details about the algorithm used can be found in {\tt ?loess}.  You can modify the wiggliness of the line by varying the span between 0, exceeding wiggly, and 1, not so wiggly, as shown in Figure~\ref{fig:smooth-loess}.  Loess does not work well for large datasets (it's $O(n^2)$ in memory), so you'll need to use one of the other methods listed below.

  % FIGURE
  %  LABEL: smooth-loess
  %  CAPTION: The effect of the span parameter.  (Left) \code{span = 0.1}, 
  %  and (right) \code{span = 1}
  % 
  % qplot(carat, price, data=dsmall, geom=c("point", "smooth"), span=0.1)
  % qplot(carat, price, data=dsmall, geom=c("point", "smooth"), span=1)
  \input{_include/ff99fb13d4c03070e4df3a79955f3f3b.tex}  
  % END

	\item {\tt method="lm"} fits a linear model.  The default will fit a straight line to your data, or you can specify {\tt formula = y $\sim$ poly(x, 2)} to specify a degree 2 polynomial, or better, load the {\tt splines} library and use a natural spline: {\tt formula = y $\sim$ ns(x, 2)}. The second parameter is the degrees of freedom: a higher number will create a wigglier curve. You are free to specify any formula involving $x$ and $y$.  

  % FIGURE
  %   LABEL: smooth-lm
  %   CAPTION: The effect of the formula parameter, using a linear model
  %   as a smoother.  (Left) \code{formula = y ~ x}, the default; (Right)
  %   \code{formula = y ~ ns(x, 3)}
  % 
  % library(splines)
  % qplot(carat, price, data=dsmall, geom=c("point", "smooth"), method="lm")
  % qplot(carat, price, data=dsmall, geom=c("point", "smooth"), method="lm", formula=y ~ ns(x,3))
  \input{_include/761e0f56f59906d486b27ea3c9454d0d.tex}
  % END

	\item {\tt method="rlm"} works the same as {\tt lm}, but uses a robust fitting algorithm so that outliers don't affect the fit as much.  It's part of the {\tt MASS} package, so remember to load that first.

	\item You could also load the {\tt mgcv} library and use {\tt method="gam", formula = y $\sim$ s(x)} to fit a generalised additive model.  This is similar 
to using a spline with {\tt lm}, but the degree of smoothness is estimated from the data.  For large data, you should use the formula {\tt y $\sim$ s(x, bs="cr")}
 
  % FIGURE
  %  LABEL: smooth-gam
  %  CAPTION: The effect of the formula parameter, using a linear model
  %   as a smoother.  (Left) \code{formula = y ~ s(x)}, the default; (Right)
  %   \code{formula = y ~ s(x, bs="cr")}
  % 
  % library(mgcv)
  % qplot(carat, price, data=dsmall, geom=c("point", "smooth"), method="gam", formula= y ~ s(x))
  % qplot(carat, price, data=diamonds, geom=c("point", "smooth"), method="gam", formula= y ~ s(x, bs="cr"))


\end{itemize}

By default, the standard errors are shown with a grey band around the smoother.  If you want to turn them off, use {\tt se=FALSE}.

\subsection{Quantiles}\label{sub:quantiles}

A smoother displays a smoothed conditional mean.  It's often useful to see a smooth estimate of other summaries of the distribution, for example the upper and lower quartiles to show the spread of the data.  We can do this with quantile regression \citep{koenker:2005}, which is basically a process to estimate smoothed conditional quantiles.  The types of smoothers we can use is much more limited compared to {\tt geom="smooth"}, but we can learn more about the conditional distribution.

For this example, we're going to zoom into a small range of diamond sizes so we can look at the distribution more closely.

% INTERWEAVE
% 
% dlittle <- subset(diamonds, carat < 2)
% qplot(carat, price, data=dlittle, geom=c("point", "quantile"))

By default, the relationship between x and y is assumed to be linear, but we can adjust this using the {\tt formula} argument, in the same way that we could for smoothers.  In this example we'll try using a natural spline, and then manually adding some change points where we can see an obvious jump on the graph.

% INTERWEAVE
% 
% qplot(carat, price, data=dlittle, geom=c("point", "quantile"), formula=y~ns(x, 3))
% qplot(carat, price, data=dlittle, geom=c("point", "quantile"), formula=y~ns(x, 3) + I(x > 1) + I(x > 1.5))

You can also adjust the quantiles displayed with the {\tt quantiles} argument:

% INTERWEAVE
% 
% qplot(carat, price, data=dlittle, geom=c("point", "quantile"), formula=y~ns(x, 3) + I(x > 1) + I(x > 1.5), quantiles=seq(0.05,0.95, 0.1))

\subsection{2d density contours}

When there is a lot of over-plotting on a plot, it is very hard to judge the relative density of points.  One way to get around this is to supplement the plot with contour lines from a 2d density estimate.  This is shown below.

% INTERWEAVE
% 
% qplot(log(carat), log(price), data=diamonds, geom=c("point","density2d"))
% })

The density estimation is described in more detail in {\tt ?kde2d}.

\subsection{Time series with line and path plots}\label{sub:line_plot}

Line and path plots are typically used for time series data.  Line plots always join the points from left to right, while path plots join them in the order that they appear in the data set (a line plot is just a path plot of the data sorted by x value).  Line plots usually have time on the x-axis, showing how a single variable has changed over time.  Path plots show how two variables have simultaneously changed over time, with time encoded in the way that the points are joined together.

Because there isn't a time variable in the diamonds data, we will use another dataset, {\tt economics}, which contains some economic data on the US measured over the last 40 years.

Let's start with a plot of unemployment over time, first as percent of people unemployed, and second as the median number of weeks unemployed:

% INTERWEAVE
% 
% qplot(date, unemploy/pop, data=economics, geom="line")
% qplot(date, uempmed, data=economics, geom="line")

These plots show the behaviour of percent unemployed, and length of unemployment individually, but it is not so easy to see the joint pattern.  Each time point occupies a point on the 2d grid of length and number, and if we joint up each point to its neighbours we get a 2d trajectory.

This can be illustrated with a path plot.  Below we plot number of unemployed vs length of unemployment and then join the individual observations with a path to show the pattern over time.  To make it more obvious in which direction time flows, we can use the {\tt size} aesthetic, as in the second plot.  We can see that number of unemployed and length of unemployment seems highly correlated, although in recent years the length of unemployment has been increasing relative to the total number of unemployed.

% INTERWEAVE
% 
% year <- function(x) as.POSIXlt(x)$year + 1900
% qplot(unemploy/pop, uempmed, data=economics, geom="path")
% year <- function(x) as.POSIXlt(x)$year + 1900
% qplot(unemploy/pop, uempmed, data=economics, geom="path", size=year(date))

\subsection{Boxplots and jittered points}\label{sub:boxplot}

If you have one categorical variable, and one or more continuous variables, you will probably be interested to know how the values of the continuous variables vary with the categorical.  Box plots and jittered points offer to ways to do this.  

This example looks at how the price per carat varies with colour of the diamond.

% INTERWEAVE
% 
% qplot(color, price/carat, data=diamonds, geom="jitter")
% qplot(color, price/carat, data=diamonds, geom="boxplot")

% Both boxplots and jittered points will try to guess which orientation they should lie, and while most of the time they will get it right, sometimes you will need to say exactly what you want.  For the boxplot, use {\tt orientation="horizontal"} or {\tt orientation="vertical"}, and for the jittered points, use {\tt xjitter} and {\tt yjitter} to specify the amount of jittering to use. 
% 
For jittered points, you have the same control over aesthetics as you do with a normal scatterplot: {\tt size}, {\tt colour}, {\tt shape}.  For boxplots you can control only the outline colour ({\tt colour}), the internal fill ({\tt fill}) and the size of the lines ({\tt size}).

Another way to look at conditional distributions is to use faceting to plot a separate histogram or density plot for each value of the categorical variable.

\subsection{Histogram and density plots}\label{sub:density}

Histogram and density plots show the distribution of a single variable.  They provide more information about the distribution of a single group than boxplots do, but it is harder to compare many groups (although we will look at one way to do so).  The next example shows the distribution of carats with a histogram and a density plot.

% INTERWEAVE
% 
% qplot(carat, data=diamonds, geom="histogram")
% qplot(carat, data=diamonds, geom="density")

You can control the amount of smoothing using the {\tt binwidth} argument for the histogram, which specifies the bin size to use.  You can also specify the break points explicitly, using the {\tt breaks} argument.  For the density plot, you can use {\tt adjust} argument, which adjusts the bandwidth of the smoother (high values of {\tt adjust} produce smoother plots).  It is {\bf very important} to experiment with the level of smoothing.  With a histogram you should try many bin widths before you decide on the one (or two, or three) which best describe the data.

For this example, we need to use a rather small bin width before we can see the full story.

% INTERWEAVE
% 
% qplot(carat, data=diamonds, geom="histogram", binwidth=1)
% qplot(carat, data=diamonds, geom="histogram", binwidth=0.1)
% qplot(carat, data=diamonds, geom="histogram", binwidth=0.01)

Density plots are useful in that they are easier to overlay, but are generally less flexible than histograms, and it is more difficult to understand exactly what a density plot is showing.  (And the density plot makes some assumptions that may not be true for our data: unbounded, continuous and smooth)  If you want to compare the distributions of different subgroups, all you need to do is add an aesthetic mapping that differentiates the different groups, as follows:

% INTERWEAVE
% 
% qplot(carat, data=diamonds, geom="density", colour=color)


\section{Faceting}\label{sec:faceting}

{\bf rewrite!}

Faceting, also known as trellising or conditioning, allows you to display small multiples of subsets of your data.  This example displays a histogram of price for each value of cut:

% INTERWEAVE
% 
% qplot(price, data=diamonds, facets= cut~ ., geom="histogram")

Each small multiple is called a facet, and contains the same plot for a different subset of the data.  The grid is specified with a faceting formula which looks like $row\_var \sim col\_var $.  You can specify as many row and column variables as you like, but in most cases more than one or two variables will produce a plot so large that it is difficult to see on screen.  If you want to facet on columns, or rows, not both, you can use {\tt .} as a place holder.  For example, $row\_var \sim .$ will facet by rows with a single variable.  

% INTERWEAVE
% 
% qplot(price, data=diamonds, facets= cut~ clarity, geom="histogram")
% })

Faceting is used to investigate conditional relationships, e.g. conditional on sex, what is the relationship between amount of smoking and lung cancer.  Faceting can also be useful for creating tables of graphics.  For some examples of this, and more ways to use faceting, see chapter XXX.

\section{Other options}\label{sec:other_options}

There are a few other options that {\tt qplot} provides to control the output of your graphic.  These all have the same effect as their {\tt plot} equivalents:

\begin{itemize}
	\item {\tt xlim}, {\tt ylim}: set limits for the x- and y-axes, each a numeric vector of length two, e.g. {\tt xlim=c(0, 20)} or {\tt ylim=c(-0.9, -0.5)}.
	\item {\tt log}: a character vector indicating which (if any) axes should be logged.  For example, {\tt log="x"} will log the x-axis, {\tt log="xy"} will log both.
	\item {\tt main}: main title for the plot, displayed in large text at the top-centre of the plot.  This can be a string (eg. {\tt main="plot title"}) or an expression (eg. {\tt main = expression(beta[1] == 1)}).  See {\tt ?plotmath} for more examples of using mathematical formulae.
	\item {\tt xlab}, {\tt ylab}: labels for the x- and y-axes.  As with the plot title, these can be character strings or mathematical expressions.
\end{itemize}

The following examples show the options in action.

% INTERWEAVE
% 
% qplot(carat, price, data=diamonds, xlab="Price ($)", ylab="Weight (carats)",  main="Price-weight relationship")
% qplot(carat, price/carat, data=diamonds, ylab=expression(frac(price,carat)), xlab="Weight (carats)",  main="Small diamonds", xlim=c(.2,1))
% qplot(carat, price, data=diamonds, log="xy")

\section{Differences from plot}
\label{sec:plot_diffs}

There are a few important differences between {\tt plot} and {\tt qplot}:

\begin{itemize}
  \item Because {\tt qplot} can produce both 1d and 2d plots, you must always specify both x and y for 2d plots.  This is different to the behaviour of plot, which uses {\tt seq\_along(y)} for x if it is not explicitly specified.
  
  \item {\tt qplot} is not generic: you can not pass any type of R object to qplot and expect to get some kind of default plot.  Note that, however, the {\tt ggplot()} is generic, and may provide a starting point for producing visualisations of arbitrary R objects.
  
  \item ggplot2 doesn't have subtitles, so there is no {\tt sub} parameter.    
  
  \item Values passed to the aesthetic attributes are mapped to values by scales.  If you want the values to be interpreted directly, surround use {\tt I()}: {\tt colour = I("red")}.  See also {\tt scale\_manual}, Page~\pageref{sec:scale_special}.
  
  \item While you can continue to use the base R aesthetic names ({\tt col},  {\tt pch}, {\tt cex} etc), it's a good idea to switch to the more descriptive ggplot2 aesthetic names ({\tt colour} , {\tt shape} and {\tt size}).

  \item If you want to add extra points or lines or text to an existing plot from base graphics you can use the {\tt points()}, {\tt lines()} and {\tt text()} functions to draw on top of the current plot.  With {\tt ggplot2} you need to add additional {\bf layers} to the existing plot, described in the next chapter.
  
\end{itemize}

\input{_footer.tex}
