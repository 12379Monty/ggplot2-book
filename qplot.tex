\input{_header.tex}

% qplot chapter suggestions:
% 
% * exercises - see plot and then try and create on your own
% * wall chart of different plot types
% * more error bar and ribbon examples
% * table of options

% SET_DEFAULTS
%   GG-WIDTH: 8  GG-HEIGHT: 4.8
%   TEX-WIDTH: 0.5\textwidth
%   INLINE: FALSE
%
% set.seed(1410)
% dsmall <- diamonds[sample(nrow(diamonds), 1000),]

% END

\chapter{Getting started with qplot}
\label{cha:qplot}

\section{Introduction} 

In this chapter, you will learn to make a wide variety of plots with your first ggplot function, \f{qplot}, short for {\bf q}uick plot. qplot makes it easy to produce complex plots, often requiring several lines of code using other plotting systems, in one line. \f{qplot} can do this because it's based on the grammar of graphics, which allows you to create a simple, yet expressive, description of the plot.  In later chapters you'll learn to use all of the expressive power of the grammar, but here we'll start simple so you can work your way up.  You will also start to learn some of the ggplot terminology that will be used throughout the book.

{\tt qplot} has been designed be very similar to {\tt plot}, which should make it easy if you're already familiar with plotting in R.  Remember, during an R session you can get a summary of all the arguments to {\tt qplot} with R help, {\tt ?qplot}.

In this chapter you'll learn:

\begin{itemize}
  \item The basic use of {\tt qplot}---If you're already familiar with {\tt plot}, this will be particularly easy, \secref{sec:basic_use}.
  \item How to map variables to aesthetic attributes, like colour, size and shape, \secref{sec:aesthetic_attributes}.
  \item How to create many different types of plots by specifying different geoms, and how to combine multiple types in a single plot. Page \secref{sec:plot_geoms}.
  \item The use of faceting, also known as trellising or conditioning, to break apart subsets of your data, \secref{sec:faceting}.
  \item How to tune the appearance of the plot by specifying some basic options, \secref{sec:other_options}.
  \item A few important differences between \f{plot} and \f{qplot}, \secref{sec:plot_diffs}
\end{itemize}

\section{Data sets}\label{sec:data_sets}

In this chapter we'll just use one data source, so you can get familiar with the plotting details rather than having to familiarise yourself with different datasets.  The {\tt diamonds} dataset consists of prices and quality information about 54,000 diamonds, and is included in the ggplot package.  The dataset has not been well cleaned, so as well as demonstrating interesting relationships about diamonds, it also demonstrates some data quality problems.  We'll also use another dataset, {\tt dsmall}, which is a random sample of 1000 diamonds.  We'll use this for plots which are more appropriate for smaller datasets.  The first few rows of the data are shown in Table~\ref{tab:diamonds}.

% decumar<<< 
% xtable(head(diamonds), digits=c(0,1,2,0,1,1,1,0,2,2,2), align="l|rrrrrrrrrr", label="tab:diamonds", caption="{\\tt diamonds} dataset")
% |||
% latex table generated in R 2.5.1 by xtable 1.5-1 package
% Fri Aug 31 13:09:07 2007
\begin{table}[ht]
\begin{center}
\begin{tabular}{lrrrrrrrrrr}
  \toprule
  carat & cut & color & clarity & depth & table & price & x & y & z \\
  \midrule
  0.2 & Ideal & E & SI2 & 61.5 & 55.0 & 326 & 3.95 & 3.98 & 2.43 \\
  0.2 & Premium & E & SI1 & 59.8 & 61.0 & 326 & 3.89 & 3.84 & 2.31 \\
  0.2 & Good & E & VS1 & 56.9 & 65.0 & 327 & 4.05 & 4.07 & 2.31 \\
  0.3 & Premium & I & VS2 & 62.4 & 58.0 & 334 & 4.20 & 4.23 & 2.63 \\
  0.3 & Good & J & SI2 & 63.3 & 58.0 & 335 & 4.34 & 4.35 & 2.75 \\
  0.2 & Very Good & J & VVS2 & 62.8 & 57.0 & 336 & 3.94 & 3.96 & 2.48 \\
  \bottomrule
\end{tabular}
\caption{{\tt diamonds} dataset}
\label{tab:diamonds}
\end{center}
\end{table}
% >>>

\section{Basic use}\label{sec:basic_use}

As with  {\tt plot}, the first two arguments to \f{qplot} are {\tt x} and {\tt y}, giving the x- and y-coordinates for the objects on the plot. There is also an optional {\tt data} argument.  If this is specified, \f{qplot} will look inside that data frame before looking for objects in your workspace.  Using the \code{data} argument is recommended: it's a good idea to keep related data in a single data frame.  If you don't specify one, \f{qplot} will try to build one up for you and may find the other variables bearing the same names.

Here is a simple example of the use of \f{qplot}.  It produces a scatterplot showing the relationship between the price and carats (weight) of a diamond. 
% INTERWEAVE
% 
% qplot(carat, price, data=dsmall)
\input{_include/8e8a9905a346490c787ff32536f7b196.tex}
% END

The plot shows a strong correlation with notable outliers and some interesting vertical striation.  The relationship looks exponential, though, so the first thing we'd like to do is to transform the variables.  Because \f{qplot} accepts functions of variables as arguments, we plot log(price) vs.\ log(carat):

% INTERWEAVE
% 
% qplot(log(carat), log(price), data=dsmall)
\input{_include/2cf703592c1bbff24a08df25d408221c.tex}
% END

\noindent The relationship now looks linear.  With this much overplotting, though, we need to be cautious about drawing firm conclusions.

Arguments can also be combinations of existing variables, so, if we are curious about the relationship between the volume of the diamond (approximately $x \times y \times z$) and its weight, we can look at the following:

% INTERWEAVE
% 
% qplot(carat, x * y * z, data=dsmall)
\input{_include/27793b2b3bae0dd973f5abf3bf9f359e.tex}
% END

We would expect the density of diamonds to be constant, and thus to see a linear relationship between volume and weight. The majority of diamonds do seem to fall along a line, but there are some large outliers.

% I don't think I see "some large outliers" in the plot.  I see some small deviations from the line.  dfs

\section{Colour, size, shape and other aesthetic attributes}\label{sec:aesthetic_attributes}

The first big difference when using {\tt qplot} instead of {\tt plot} comes when you want to assign colours---or sizes or shapes---to the points on your plot.  With {\tt plot}, it's your responsibility to convert a categorical variable in your data (e.g., ``apples'', ``bananas'', ``pears'') into something that {\tt plot} knows how to use (e.g., ``red'', ``yellow'', ``green'').  {\tt qplot} can do this for you automatically, and it will automatically provide a legend that maps the displayed attributes to the data values.  This makes it easy to include additional data on the plot.  

In the next example, we augment the plot of carat and price with information about diamond colour, clarity and cut.

% FIGURE
%  LABEL: qplot-aesthetics
%  CAPTION: Mapping colour (using the argument "colour=cut", left), size ("size=cut", middle) and shape ("shape=cut", right) of 
%    points to quality of cut.
%  TEX-WIDTH: 0.33\textwidth GG-WIDTH: 4 GG-HEIGHT: 4
% 
% qplot(carat, price, data=dsmall, colour=cut)
% qplot(carat, price, data=dsmall, size=cut)
% qplot(carat, price, data=dsmall, shape=cut)
\input{_include/3828ba9cce09de1488c78d656bf9c9e6.tex}
% END

Colour, size and shape are all examples of aesthetic attributes, visual properties that affect the way observations are displayed.  For every aesthetic attribute, there is a function, called a \emph{scale}, which maps data values to valid values for that aesthetic.  It is this scale that controls how the points appear.  For example, in the above plots, the colour scale maps J to purple and F to green. (Note that while I use British spelling throughout this book, the software also accepts American spellings.)

You can also manually set the aesthetics using \f{I}.  For example, \code{colour = I("red")} or \code{size = I(2)}.  This is different to mapping and is explained in more detail in Section~\ref{sub:setting-mapping}.  For large data sets, like the diamonds data, semi-transparent points are often useful to alleviate some of the overplotting.  To make a semi-transparent colour you can use \code{alpha(colour, transparency)}, where \code{colour} is an R colour (described in Appendix~\ref{cha:specifications}) and transparency is a value between 0 (completely transparent) and 1 (complete opaque).  It's often useful to specify the transparency as a fraction, e.g. \code{1/10} or \code{1/20}, as the denominator specifies the number of points that must overplot to get a completely opaque colour.

A big difference between the use of setting and map is scales.  Mapping uses a scale, setting does not.

% EXPAND ABOVE SECTION  and add an example


Different types of aesthetic attributes work better with different types of variables.  For example, colour and shape work well with categorical variables, while size works better with continuous variables.  The amount of data also makes a difference: if there is a lot of data, like in the plots above, it can be hard to distinguish the different groups.  An alternative solution is to use faceting, which will be introduced in Section~\ref{sec:faceting}.

\section{Plot geoms}\label{sec:plot_geoms}

{\tt qplot} is not limited to scatterplots, but can produce almost any kind of plot by varying the {\bf geom} argument. Geom, short for geometric object, describes the type of object that is used to display the data.  Some geoms have an associated statistical transformation, for example, a histogram is a binning statistic plus a bar geom.  These different components are described in the next chapter.  Here we'll introduce you to the most common and useful geoms, divided up by the dimensionality of data that they work with.  The following geoms enable you to investigate two-dimensional relationships:

\begin{itemize}

  \item {\tt geom="point"} draws points to produce a scatterplot (the default), as described above.

  \item {\tt geom="smooth"} fits a smoother to the data and displays the smooth and its standard error, \secref{sub:smooth}.

  \item {\tt geom="quantile"} displays conditional density estimates.  You can think of this as an extension of boxplots to deal with the case of a continuous conditioning variable, \secref{sub:quantile}.

  \item {\tt geom="density2d"} adds contours of a 2d density estimate.  This is very useful when you have a lot of overplotting, \secref{sub:density2d}

  \item {\tt geom="boxplot"} produces a box and whisker plot to summarise the distribution of a set of points, \secref{sub:boxplot}

  \item {\tt geom="path"} and {\tt geom="line"} draw lines between the data points.  Traditionally these are used to explore relationships between time and another variable, but lines may be used to join observations connected in some other way.  A line plot is constrained to produce lines that travel from left to right, while paths can go in any direction.  \secref{sub:line}.
\end{itemize}

For 1d distributions, your choice of geoms is guided by the variable type:

\begin{itemize}
  \item For continuous variables, {\tt geom="histogram"} draws a histogram and {\tt geom="density"} creates a density plot, \secref{sub:distribution}.

  \item For discrete variables, {\tt geom="bar"} makes a barchart, \secref{sub:bar}.

\end{itemize}

% Other types of plots for dealing with categorical data (bar charts, mosaic plots, spineplots, spinograms) are dealt with in chapter X, using the special categorical plotting function {\tt catplot}.


\subsection{Adding a smoother to a plot}\label{sub:smooth}

If you have a scatterplot with many data points, it can be hard to see exactly what trend is shown by the data.  In this case you may want to add a smoothed line to the plot.  This is easily done using the {\tt smooth} geom:

% INTERWEAVE
%  FILETYPE: png
% 
% qplot(carat, price, data=dsmall, geom=c("smooth", "point"))
\input{_include/7046006a17587b7e824392c4b250043c.tex}
% END

Despite overplotting, our impression of a exponential relationship between price and carat was correct, but we'll have to do something about that influential outlier.  

Notice that we have combined multiple geoms by supplying a vector of geom names to {\tt qplot}.  The geoms will be overlaid in the order in which they appear.  By default, a point-wise confidence interval is shown with a grey band around the smoother.  If you want to turn it off, use {\tt se=FALSE}.

There are many different smoothers you can choose using the {\tt method} argument:

\begin{itemize}
  \item {\tt method="loess"}, the default, uses a smooth local regression.  More details about the algorithm used can be found in {\tt ?loess}.  The wiggliness of the line is controlled by the span parameter, which ranges from 0 (exceeding wiggly) to 1 (not so wiggly), as shown in Figure~\ref{fig:smooth-loess}.  Loess does not work well for large datasets (it's $O(n^2)$ in memory), so you'll need to use one of the other methods listed below.

  % FIGURE
  %  FILETYPE: png
  %  LABEL: smooth-loess
  %  CAPTION: The effect of the span parameter.  (Left) \code{span = 0.1}, 
  %  and (right) \code{span = 1}
  % 
  % qplot(carat, price, data=dsmall, geom=c("point", "smooth"), span=0.1)
  % qplot(carat, price, data=dsmall, geom=c("point", "smooth"), span=1)
  \input{_include/72d71f6b531f714575e2a37c8a251e80.tex}  
  % END

  \item {\tt method="lm"} fits a linear model.  The default will fit a straight line to your data, or you can specify {\tt formula = y $\sim$ poly(x, 2)} to specify a degree 2 polynomial, or better, load the {\tt splines} library and use a natural spline: {\tt formula = y $\sim$ ns(x, 2)}. The second parameter is the degrees of freedom: a higher number will create a wigglier curve. You are free to specify any formula involving $x$ and $y$.  

  % FIGURE
  %   FILETYPE: png
  %   LABEL: smooth-lm
  %   CAPTION: The effect of the formula parameter, using a linear model
  %   as a smoother.  (Left) \code{formula = y ~ x}, the default; (Right)
  %   \code{formula = y ~ ns(x, 3)}
  % 
  % library(splines)
  % qplot(carat, price, data=dsmall, geom=c("point", "smooth"), method="lm")
  % qplot(carat, price, data=dsmall, geom=c("point", "smooth"), method="lm", formula=y ~ ns(x,3))
  \input{_include/ab6f15a3c1aa9869fb1011c36129f919.tex}  
  % END

  \item {\tt method="rlm"} works like {\tt lm}, but uses a robust fitting algorithm so that outliers don't affect the fit as much.  It's part of the {\tt MASS} package, so remember to load that first.

  \item You could also load the {\tt mgcv} library and use {\tt method="gam", formula = y $\sim$ s(x)} to fit a generalised additive model.  This is similar 
to using a spline with {\tt lm}, but the degree of smoothness is estimated from the data.  For large data, use the formula {\tt y $\sim$ s(x, bs="cr")}
 
  % FIGURE
  %  FILETYPE: png
  %  LABEL: smooth-gam
  %  CAPTION: The effect of the formula parameter, using a linear model
  %   as a smoother.  (Left) \code{formula = y ~ s(x)}, the default; (Right)
  %   \code{formula = y ~ s(x, bs="cr")}
  % 
  % library(mgcv)
  % qplot(carat, price, data=dsmall, geom=c("point", "smooth"), method="gam", formula= y ~ s(x))
  % qplot(carat, price, data=dsmall, geom=c("point", "smooth"), method="gam", formula= y ~ s(x, bs="cr"))
  \input{_include/8ab3a96c1b91a4637eb820b93a4c66c5.tex}  
  % END


\end{itemize}

\subsection{Quantiles}
\label{sub:quantile}

We have just seen one example of the use of {\tt qplot} to enhance plots of raw data with distributional statistics: the smoothed conditional mean and standard error.  It is equally easy to add quantiles to describe the spread of the data.  We can do this with quantile regression \citep{koenker:2005}, which estimates smoothed conditional distributions.  The functional form is more limited than for the smooth geom, but we can learn more about the conditional distribution.  This geom requires the \code{quantreg} package to be installed, it will be loaded when needed.

For this example we will zoom in on a small range of diamond weights to look more closely at the distribution of price vs.\ carat.

% INTERWEAVE
%  FILETYPE: png
% 
% dlittle <- subset(dsmall, carat < 2)
% qplot(carat, price, data=dlittle, geom=c("point", "quantile"))
\input{_include/a8a8466e67f42b4d39fe94057dda738c.tex}
% END

The relationship between x and y is assumed by default to be linear, as shown in the above plot, but we can adjust the relationship using the {\tt formula} argument, as we did for smoothing. Figure~\ref{fig:quantile-formula} shows a natural spline at left and a linear model with fixed break points at right.  By default only the median and upper and lower quartiles are shown.

In Figure~\ref{fig:quantile-quantiles}, we have added 5\%, 15\%, ..., 95\% quantiles using the argument {\tt quantiles = seq(0.05, 0.95, 0.1)}.

% FIGURE
%   FILETYPE: png
%   LABEL: quantile-formula
%   CAPTION: The \code{formula} 
%    argument is used to control the functional form of the relation.  
%    Left, a natural spline with five degrees of freedom,
%    \code{formula = y ~ ns(x, 5)} and right, a linear model
%    with break points at 0.5, 1, and 1.5 carats, 
%    \code{formula = y ~ x + I(x > 0.5) + I(x > 1) + I(x > 1.5))}
% 
% qplot(carat, price, data=dlittle, geom=c("point", "quantile"), formula=y~ns(x, 5))
% qplot(carat, price, data=dlittle, geom=c("point", "quantile"), formula=y~ x + I(x > 0.5) + I(x > 1) + I(x > 1.5))
\input{_include/9d4db7209281fc4c49c2bcd947d287e6.tex}
% END

% FIGURE
%   FILETYPE: png
%   LABEL: quantile-quantiles
%   CAPTION: Showing 5\%, 15\%, ..., 95\% quantiles with 
%   {\tt quantiles = seq(0.05, 0.95, 0.1)}
% 
% qplot(carat, price, data=dlittle, geom=c("point", "quantile"), quantiles=seq(0.05,0.95, 0.1))
\input{_include/2008fd4a03bec114f2ca58a8f59bd046.tex}
% END

\subsection{Two-dimensional density contours}
\label{sub:density2d}

When a scatterplot suffers from overplotting, it is hard to judge the relative density of points.  This can happen even when the number of points is not large, as with the scatterplot of price vs.\ carat for a subset of the data.  One solution is to supplement the plot with contour lines from a 2d density estimate, using {\tt geom=c("point", "density2d")}.  Figure~\ref{fig:density2d} shows the resulting plot for all the diamonds and makes it clear that most of them are relatively small and inexpensive.

% FIGURE
%  LABEL: density2d
%  FILETYPE: png
%  CAPTION: Scatterplot of price vs.\ carat supplemented with contours 
%    of a 2d density estimate ({\tt geom=c("point", "density2d")}).  Most
%    diamonds are small and inexpensive.
% 
% qplot(carat, price, data=diamonds, geom=c("point","density2d"))
\input{_include/0f7ffa9a051d3aaa9837847cab46e532.tex}
% END

The density estimation is carried out by \f{kde2d}, which is described in more detail in its documentation.

\subsection{Boxplots and jittered points}
\label{sub:boxplot}

When a set of data includes a categorical variable and one or more continuous variables, you will probably be interested to know how the values of the continuous variables vary with the levels of the categorical variable.  Box plots and jittered points offer two ways to do this.  Figure~\ref{fig:jitter-boxplot} explores how the distribution of price per carat varies with the colour of the diamond using jittering ({\tt geom="jitter"}, left) and box and whisker plots ({\tt geom="boxplot"}, right).

% FIGURE
%   LABEL: jitter-boxplot
%   FILETYPE: png
%   CAPTION: Using jittering (left) and boxplots (right) to investigate
%   the distribution of price per carat conditional on colour.  As the colour
%   improves (from left to right) the spread of values decreases, but there
%   is little change in the middle half of the distribution.
% 
% qplot(color, price/carat, data=diamonds, geom="jitter")
% qplot(color, price/carat, data=diamonds, geom="boxplot")
\input{_include/b05df8a34f07b110e9dd50bd836a7a36.tex}
% END

Each method has its strengths and weaknesses.  Boxplots summarise the bulk of the distribution with only five numbers, while jittered plots can suffer from overplotting.  In the example here, both plots show the dependency of the spread of price per carat on diamond colour, but the boxplots are more informative, indicating that there is very little change in the median and adjacent quartiles.

The overplotting seen in the plot of jittered values can be alleviated somewhat by using semi-transparent points using the {\tt colour} argument. Figure~\ref{fig:jitter-alpha} illustrates three different levels of transparency, which make it easier to see where the bulk of the points lie.  For the leftmost plot, for example, the command is:

{\tt qplot(color, price/carat, data=diamonds, geom="jitter",
    colour=I(alpha("black", 1/5)))}

This technique can't show the positions of the quantiles as well as a boxplot can, but it may reveal other features of the distribution that a boxplot can not.

% FIGURE
%   LABEL: jitter-alpha
%   FILETYPE: png
%   CAPTION: Varying the alpha level.  From left to right: $1/5$, $1/50$, $1/200$.  As the opacity decreases we begin to see where the bulk of the data
%   lies.  However, the boxplot still does much better.
%   GG-WIDTH: 4 GG-HEIGHT: 4 TEX-WIDTH: 0.33\textwidth
% 
% qplot(color, price/carat, data=diamonds, geom="jitter", colour=I(alpha("black", 1/5)))
% qplot(color, price/carat, data=diamonds, geom="jitter", colour=I(alpha("black", 1/50)))
% qplot(color, price/carat, data=diamonds, geom="jitter", colour=I(alpha("black", 1/200)))
\input{_include/e7860c57ffcf8f1c08c5d357452e4324.tex}
% END

% Both boxplots and jittered points will try to guess which orientation they should lie, and while most of the time they will get it right, sometimes you will need to say exactly what you want.  For the boxplot, use {\tt orientation="horizontal"} or {\tt orientation="vertical"}, and for the jittered points, use {\tt xjitter} and {\tt yjitter} to specify the amount of jittering to use. 
% 
For jittered points, {\tt qplot} offers the same control over aesthetics as it does for  a normal scatterplot: {\tt size}, {\tt colour}, and {\tt shape}.  For boxplots you can control the outline colour ({\tt colour}), the internal fill ({\tt fill}) and the size of the lines ({\tt size}).

Another way to look at conditional distributions is to use faceting to plot a separate histogram or density plot for each value of the categorical variable.  This is demonstrated in Section~\ref{sec:faceting}.

\subsection{Histogram and density plots}\label{sub:distribution}

Histogram and density plots show the distribution of a single variable.  They provide more information about the distribution of a single group than boxplots do, but it is harder to compare many groups (although we will look at one way to do so).  Figure~\ref{fig:dist} shows the distribution of carats with a histogram and a density plot.

% FIGURE
%   LABEL: dist
%   CAPTION: Displaying the distribution of diamonds.  (Left) 
%    \code{geom = "histogram"} and (right) \code{geom = "density"}
% 
% qplot(carat, data=diamonds, geom="histogram")
% qplot(carat, data=diamonds, geom="density")
\input{_include/f7e56ab9c54ec6e4a2868f53ef1e8abe.tex}
% END

For the density plot, the {\tt adjust} argument controls the bandwidth of the smoother (high values of {\tt adjust} produce smoother plots). For the histogram, the {\tt binwidth} argument controls the amount of smoothing by setting the bin size.  (Break points can also be specified explicitly, using the {\tt breaks} argument.) It is {\bf very important} to experiment with the level of smoothing.  With a histogram you should try many bin widths: You may find that gross features of the data show up well at a large bin width, while finer features require a very narrow width.

In Figure~\ref{fig:hist-binwidth}, we experiment with three values of {\tt binwidth}: 1.0, 0.1, and 0.01.  It is only in the plot with the smallest bin width (right), that we see the striations we noted in an earlier scatterplot, most at ``nice'' numbers of carats. The full command is:

{\tt qplot(carat, data=diamonds, geom="histogram", binwidth=1, xlim=c(0,3))}


% FIGURE
%   LABEL: hist-binwidth
%   CAPTION:  Varying the bin width on a histogram of carat reveals 
%    interesting patterns.  Binwidths from left to right: 1, 0.1, and 0.01 
%    carats. Only diamonds with carats between 0 and 3 shown. 
%   TEX-WIDTH: 0.33\textwidth
%
% qplot(carat, data=diamonds, geom="histogram", binwidth=1, xlim=c(0,3))
% qplot(carat, data=diamonds, geom="histogram", binwidth=0.1, xlim=c(0,3))
% qplot(carat, data=diamonds, geom="histogram", binwidth=0.01, xlim=c(0,3))
\input{_include/13041aa3b6aea44382743682027d9c72.tex}
% END

To compare the distributions of different subgroups, just add an aesthetic mapping, as follows:

{\tt qplot(carat, data=diamonds, geom="density", colour=color, size=I(1.5))}

Mapping a categorical variable to an aesthetic will automatically split up the geom by that variable, so this command instructs qplot to draw a density plot for each level of diamond color, and to draw each curve using a different colour and a fixed line width of 1.5. It produces the first plot in Figure~\ref{fig:dist-fill}.

The second plot is produced with a similar command:

{\tt qplot(carat, data=diamonds, geom="histogram", fill=color)}

The density plot is more appealing at first because it seems easy to read and compare the various curves. However, it is more difficult to understand exactly what a density plot is showing.  In addition, the density plot makes some assumptions that may not be true for our data; i.e., that it is unbounded, continuous and smooth.

% FIGURE
%   LABEL: dist-fill
%   CAPTION: Mapping a categorical variable to an aesthetic will automatically
%    split up the geom by that variable.  (Left) Density plots are overlaid
%    and (right) histograms are stacked.
% 
% qplot(carat, data=diamonds, geom="density", colour=color, size = I(1.5))
% qplot(carat, data=diamonds, geom="histogram", fill=color)
\input{_include/4fc3e887c7254f5441e7c6301df83999.tex}
% END

\subsection{Bar charts}
\label{sub:bar}

The discrete analogue of histogram is the bar chart,~\code{geom = "bar"}.  The bar geom counts the number of instances of each class so that you don't need to tabulate your values beforehand with \code{barchart} in base R.  If the data has already been tabulated or if you'd like to tabulate class members in some other way, such as by summing up a continuous variable, you can use the \code{weight} geom. This is illustrated in Figure~\ref{fig:dist-bar}.  The first plot is a simple bar chart of diamond colour, and the second is a bar chart of diamond colour weighted by carat:

% {\tt qplot(color, data=diamonds, geom="bar", weight = carat) + scale_y_continuous("carat")}
% %
% (The second expression in the command sets the y-axis label to emphasize the difference between the plots.  Axis labels are discussed in Section foo.)

% FIGURE
%   LABEL: dist-bar
%   CAPTION: Bar charts of diamond colour.  The left plot shows counts and the 
%   right plot is weighted by \code{weight = carat} to show the total weight
%   of diamonds of each colour.
% 
% qplot(color, data=diamonds, geom="bar")
% qplot(color, data=diamonds, geom="bar", weight = carat) + scale_y_continuous("carat")
\input{_include/6f9143634f8becd68e182d9a5172f81a.tex}
% END

\subsection{Time series with line and path plots}
\label{sub:line}

Line and path plots are typically used for time series data.  Line plots always join the points from left to right, while path plots join them in the order that they appear in the data set (a line plot is just a path plot of the data sorted by x value).  Line plots usually have time on the x-axis, showing how a single variable has changed over time.  Path plots show how two variables have simultaneously changed over time, with time encoded in the way that the points are joined together.

Because there is no time variable in the diamonds data, we use the {\tt economics} dataset, which contains economic data on the US measured over the last 40 years.  Figure~\ref{fig:line-employment} shows two plots of unemployment over time, both produced using {\tt geom="line"}.  The first shows an unemployment rate and the second shows the median number of weeks unemployed.  We can already see some differences in these two variables, particularly in the last peak, where the unemployment percentage is lower than it was in the preceding peaks, but the length of unemployment is high.

% FIGURE
%  LABEL: line-employment
%  CAPTION: Two time series measuring amount of unemployment.  ({\sc left}) 
%   Percent of population that is unemployed and ({\sc right}) median
%   number of weeks unemployed.  Plots created with {\tt geom="line"}.
% 
% qplot(date, unemploy/pop, data=economics, geom="line")
% qplot(date, uempmed, data=economics, geom="line")
\input{_include/6c41e9917f3cae107adca7a7795f50f6.tex}
% END

To examine this relationship in greater detail, we would like to draw both time series on the same plot.  We could draw a scatterplot of unemployment rate vs.\ length of unemployment, but then we could no longer see the evolution over time.  The solution is to join points adjacent in time with line segments, forming a \emph{path} plot.

Below we plot unemployment rate vs.\ length of unemployment and join the individual observations with a path.  Because of the many line crossings, the direction in which time flows isn't easy to see in the first plot.  In the second plot, we apply the {\tt size} aesthetic to the line, increasing its width as time advances.

{\tt
qplot(unemploy/pop, uempmed, data=economics, geom="path", size=year(date))
}

We can see that percent unemployed and length of unemployment is highly correlated, although in recent years the length of unemployment has been increasing relative to the unemployment rate.

% INTERWEAVE
% 
% year <- function(x) as.POSIXlt(x)$year + 1900
% qplot(unemploy/pop, uempmed, data=economics, geom="path")
% qplot(unemploy/pop, uempmed, data=economics, geom="path", size=year(date))
\input{_include/56d055feb59e63f027f402a9b602e143.tex}
% END

With longitudinal data, you often want to display multiple time series on each plot, each series representing one individual.  To do this with \f{qplot}, you need to map the \code{group} aesthetic to a variable encoding the group membership of each observation. This is explained in more depth in Section~\ref{sub:grouping}.

\section{Faceting}\label{sec:qplot-faceting}

We have already discussed using aesthetics (colour and symbol) to compare subgroups, drawing all groups on the same plot. Faceting takes an alternative approach: It creates tables of graphics by splitting the data into subsets and displaying the same graph for each subset in an arrangement that facilitates comparison. Section~\ref{sec:faceting} discusses faceting in details, including a discussion of the advantages and disadvantages of using faceting instead of aesthetics in Section~\ref{sub:group-vs-facet}.

The default faceting method in \f{qplot} creates plots arranged on a grid specified by a faceting formula which looks like {\tt row\_var $\sim$ col\_var}.  You can specify as many row and column variables as you like, keeping in mind that using more than two variables will often produce a plot so large that it is difficult to see on screen.  To facet on only one of columns or rows, use {\tt .} as a place holder.  For example, {\tt row\_var $\sim$ .} will create a single column with multiple rows.

% dfs: I kind of think it's just confusing to show two plots here. It
% isn't obvious at first glance that you <are> showing two plots, and it
% raises questions that you aren't ready to answer (..density..??)
%   I'd back off and just show the proportions. 
% Or is it worth it to facet by colour and cut?  Maybe a subset of
% the levels of each variable just to show how it is done?

Figure~\ref{fig:facet-hist} illustrates this technique with two plots, sets of histograms showing the distribution of carat conditional on colour. This command generates the first column of plots, which shows counts:

{\tt
 qplot(carat, data=diamonds, facets=color \verb|~| ., geom="histogram", binwidth=0.1, xlim=c(0, 3))
}
%
The second set of histograms shows proportions, making it easier to compare distributions regardless of the relative abundance of diamonds of each colour. High-quality diamonds (colour D) are skewed towards small sizes, and as quality declines the distribution becomes more flat.  


% FIGURE
%   LABEL: facet-hist
%   GG-HEIGHT: 8 GG-WIDTH: 4
%   CAPTION: Histograms showing the distribution of carat conditional on
%   colour.  {\sc (Left)} Bars show counts and ({\sc Right}) bars show
%   densities (proportions of the whole).  The density plot makes it
%   easier to compare distributions ignoring the relative abundance of 
%   diamonds within each colour.  Facets created with 
%   \code{facets = colour ~ .}
% 
% qplot(carat, data=diamonds, facets=color ~ ., geom="histogram", binwidth=0.1, xlim=c(0, 3))
% qplot(carat, ..density.., data=diamonds, facets=color ~ ., geom="histogram", binwidth=0.1, xlim=c(0, 3))
\input{_include/f0d73c7a568e56132e8915bed8ca93c9.tex}
% END

\section{Other options}\label{sec:other_options}

These are a few other {\tt qplot} options to control the graphic's appearance. These all have the same effect as their {\tt plot} equivalents:

\begin{itemize}
  \item {\tt xlim}, {\tt ylim}: set limits for the x- and y-axes, each a numeric vector of length two, e.g. {\tt xlim=c(0, 20)} or {\tt ylim=c(-0.9, -0.5)}.
  \item {\tt log}: a character vector indicating which (if any) axes should be logged.  For example, {\tt log="x"} will log the x-axis, {\tt log="xy"} will log both.
  \item {\tt main}: main title for the plot, centered in large text at the top of the plot.  This can be a string (eg. {\tt main="plot title"}) or an expression (eg. {\tt main = expression(beta[1] == 1)}).  See {\tt ?plotmath} for more examples of using mathematical formulae.
  \item {\tt xlab}, {\tt ylab}: labels for the x- and y-axes.  As with the plot title, these can be character strings or mathematical expressions.
\end{itemize}

The following examples show the options in action.

% INTERWEAVE
% 
% qplot(
%   carat, price, data=dsmall, 
%   xlab="Price ($)", ylab="Weight (carats)",  
%   main="Price-weight relationship"
% )
% qplot(
%    carat, price/carat, data=dsmall, 
%    ylab = expression(frac(price,carat)), 
%    xlab = "Weight (carats)",  
%    main="Small diamonds", 
%    xlim = c(.2,1)
% )
% qplot(carat, price, data=dsmall, log="xy")
\input{_include/a9c57a554e61a833acd96b368ca019c7.tex}
% END

\section{Differences from plot}
\label{sec:plot_diffs}

There are a few important differences between {\tt plot} and {\tt qplot}:

\begin{itemize}
  \item Because {\tt qplot} can produce both 1d and 2d plots, you must always specify both x and y for 2d plots.  This is different to the behaviour of plot, which uses {\tt seq\_along(y)} for x if it is not explicitly specified.
  
  \item {\tt qplot} is not generic: you can not pass any type of R object to qplot and expect to get some kind of default plot.  Note, however, that {\tt ggplot()} is generic, and may provide a starting point for producing visualisations of arbitrary R objects.
  
  \item Values passed to the aesthetic attributes are mapped to values by scales.  If you want the values to be interpreted directly, use {\tt I()}: {\tt colour = I("red")}.  See also setting vs mapping, Page~\pageref{sub:setting-mapping} and {\tt scale\_manual}, Page~\pageref{sec:scale_special}.        % dfs: could you expand this?  I didn't quite get it.
  
  \item While you can continue to use the base R aesthetic names ({\tt col},  {\tt pch}, {\tt cex}, etc.), it's a good idea to switch to the more descriptive ggplot2 aesthetic names ({\tt colour}, {\tt shape}, and {\tt size}).

% dfs:  Why is this a good idea?

  \item To add further graphic elements to a plot produced in base graphics, you can use {\tt points()}, {\tt lines()} and {\tt text()}.  With {\tt ggplot2}, you need to add additional {\bf layers} to the existing plot, described in the next chapter.
  
\end{itemize}

\input{_footer.tex}
