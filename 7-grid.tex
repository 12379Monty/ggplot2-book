\input{header.tex}

% \setchapterpreamble[u]{% 
% \dictum[Friedrich Nietzsche]{He who fights with monsters might take care lest he thereby become a monster. And if you gaze for long into an abyss, the abyss gazes also into you.}} 

\newpage
\chapter{Customising the display of ggplot graphics.}

This chapter describes two ways to modify the appearance of ggplot graphics by changing convenient options or by modifying the underlying structure provide by grid \citep{grid}.  The options provided by {\tt ggopt} allow you to easily modify the most commonly tweaked parts of ggplot graphics.  These options can only go so far, and so the final section of this chapter describes how to use the power of grid graphics to delve into the dark depths of {\tt ggplot} and tweak to your heart's content.  

Please remember that ggplot has been carefully designed to provide perceptually well-founded defaults, and you should think carefully about what you are doing before you make any big changes.  Some particularly good references to consult are:

\begin{itemize}
	\item \citet{wilkinson:2006}, in general.
	\item \citet{cleveland:1993,cleveland:1987,cleveland:1994}.
	\item \citet{tufte:2006,tufte:1990,tufte:1997,tufte:2001}, for generally how to make beautiful graphics.
	\item \citet{bertin:1983,bertin:1967}, especially for maps.
	\item \citet{brewer:1994,brewer:1994a}, for the choice of colours, particularly for area plots.
	\item \citet{carr:1999,carr:1994,carr:2002}, for the use of colour in general.
\end{itemize}

This chapter can not hope to provide a comprehensive introduction to grid, but should hopefully provide enough examples that even if you have never used grid before you should be able to customise ggplot to meet your needs.  I highly recommend the book ``R Graphics'' \citep{murrell:2005} as a companion to this chapter, or if you are interested in learning more about grid.   

The ``grobs'' (graphical objects) used in this chapter are a bit different to the geoms (geometric objects) used in previous chapters.  A grob is the object that is actually drawn to on the screen, while a geom is a more abstract object which describes the type of object used to draw a plot.  An example may make this more clear. In a line plot, the geom describes that the data should be visualised with a line, and the grobs draw the line itself, as well as the other lines that appear in the grid and axes.

\section{Options}\label{sec:options}

There are two ways to set options:

\begin{itemize}
  \item globally (for all plots), using {\tt ggopt}
  \item locally (for one plot), using \$. 
\end{itemize}     
                 
\begin{tabular}{lp{1in}p{3.6in}}
Option & Valid Values & Details \\
\hline
background.fill    & any colour & Background fill colour behind entire plot\\
background.colour  & any colour & \\
grid.colour        & any colour & Colour of grid lines within panel \\
grid.fill          & any colour & Panel background colour \\
strip.gp           & gpar object & Graphical parameters used for strip. Colour and fill of most interest \\
strip.text.gp      & any colour & Graphical parameters used for strip text. \\
strip.text         & a function & Function should accept two arguments, variable and value and return a character vector of length one. Function which determines how strip labels are formatted \\
legend.position    & left, right, top, 

bottom, none, 

c(x, y) & Position of legend.  Can use numeric vector of length 2 to set position of centre of length, units are npc relative to whole plot viewport. \\
aspect.ratio       & a number or NULL & Aspect ratio of plot. \\
\hline
\end{tabular}

The following example demonstrates some of the possibilities.

% decumar<<< 
% dsmall <- diamonds[sample(1:nrow(diamonds), 1000), ]
% doptions(height=3, width=4)
% interweave({
% # Always a good idea to save existing options before making
% # radical changes
% old <- ggopt(grid.colour="grey50", grid.fill="white")
% qplot(carat, price, data=dsmall)
% (p <- qplot(cut, clarity, data=dsmall, geom="jitter"))
% # Only changes the current plot
% p$grid.colour <- "darkgreen"
% p
% # Restore old settings:
% ggtheme(old)
% p
% })
% |||
\begin{alltt}
> old <- ggopt(grid.colour = "grey50", grid.fill = "white")
> qplot(carat, price, data = dsmall)
\includegraphics[scale=1]{./include/7f8d370a14179d509879f35839b54ea9}

> (p <- qplot(cut, clarity, data = dsmall, geom = "jitter"))
\includegraphics[scale=1]{./include/5830a37fc4252db571b25f373c8f141f}

> p$grid.colour <- "darkgreen"
> p
\includegraphics[scale=1]{./include/656e171fb34b88b28f6789aa9ad535e6}

> ggtheme(old)
> p
\includegraphics[scale=1]{./include/656e171fb34b88b28f6789aa9ad535e6}

\end{alltt}
% >>>

\subsection{Themes}\label{sub:themes}

It is also possible to create a theme which encapsulates multiple options.  A theme is a very simple structure, just a list of multiple options, so it's  easy to create your own.  One theme is included by default: {\tt theme\_bw}, which sets up a white background with black grid lines.  You can use a theme with {\tt ggtheme(theme)}, or for a single plot {\tt update(plot, theme)}.

% decumar<<< 
% interweave({
% ggtheme(theme_bw)
% qplot(carat, price, data=dsmall)
% })
% |||
\begin{alltt}
> ggtheme(theme_bw)
> qplot(carat, price, data = dsmall)
\includegraphics[scale=1]{./include/7f8d370a14179d509879f35839b54ea9}

\end{alltt}
% >>>

\newpage
\section{Structure of a plot}\label{sec:structure_of_a_plot}

To annotate or edit a plot, you first need to figure out what you want to change, and what it is called.  If you are annotating plots, you will need to know the name of the appropriate viewport.  If you are editing plots, you will need to know the name of the appropriate grob.  This section gives a general overview of the structure of a plot, and describes useful commands for figuring out the structure of your particular plot.

\subsection{Viewports}\label{sub:viewports}

The structure of viewports will vary slightly from plot to plot, depending on the type of facetting.  For a plot produced with {\tt facet\_grid}, the viewports are described below.  For other types of facetting, the details will vary slightly, and are described in the documentation for that facetting system.  

The {\tt layout} viewport contains the meat of the plot: strip labels, axes and facetting panels.  The viewports are named according to their role and their position.  A viewport name is made up of a prefix (listed below) which describes the contents of the viewport, and x and y position (counting from bottom left) separated by ``\_''.

\begin{itemize}
  \item {\tt labels\_h}: horizontal strip labels
  \item {\tt labels\_v}: vertical strip labels
  \item {\tt axis\_h}: horizontal axes
  \item {\tt axis\_v}: vertical axes
  \item {\tt panel}: facetting panels
\end{itemize}

Some examples will help make this concrete:

\begin{itemize}
  \item {\tt panel\_1\_1}: the first panel in the top left
  \item {\tt axis\_h\_1\_4}: the fourth horizontal axis
  \item {\tt labels\_v\_3\_1}: the third vertical axis
\end{itemize}

You can see all the viewports on the current plot by typing {\tt current.vpTree(all=TRUE)}.

\begin{sidebar}
  Unfortunately there is a bug in grid which prevents all the viewports being displayed, but hopefully this will be resolved soon.  You can get around this by printing only the bare necessities of the plot:

  \begin{alltt}
  p <- qplot(wt, mpg, data=mtcars, colour=cyl)
  print(p, pretty = FALSE)
  current.vpTree(all=TRUE)
  \end{alltt}  
\end{sidebar}


\subsection{Grobs}
\label{sub:grobs}

Grob names have three components: the name of the grob, the class of the grob, and a unique numeric suffix.  The three components are joined together with ``.'' to give a name like {\tt title.text.435} or {\tt ticks.segments.15}.  These three components ensure that all grob names are unique, but also you to select multiple grobs with the same name at the same time.

You can see a list of all the grobs in the current plot by running {\tt current.grobTree()}.  If you only want to see the name of the grob, {\tt current.grobTree(only.name=TRUE)} will reduce a lot of the output.  Here's an example of the output:

\begin{alltt}
plot-surrounds::
 background
 plot::
  background
  guide:: (background, major-horizontal, major-vertical, 
           minor-horizontal, minor-vertical, border)
  xaxis::
   ticks
   labels:: (label, label, label, label, label, label, label, label)
  yaxis::
   ticks
   labels:: (label, label, label, label, label)
  geom_jitter
 ylabel
 xlabel
 title
\end{alltt}

Notice that the grobs are arranged in a hierarchical manner. 

The most important components are:

\begin{itemize}
  \item {\tt guide}, the internal guides within a panel (background, and grid lines)

  \item {\tt xaxis} and {\tt yaxis}, the axes, containing {\tt labels} and {\tt ticks}.

	\item Axis labels and title: {\tt xlabel}, {\tt ylabel}, {\tt title}.

  \item The geom displayed in the plot: {\tt geom_jitter}.

	\item Another important component not shown in this example are {\tt strip}s: containing the {\tt background} background fill and {\tt label}.

\end{itemize}


\newpage
\section{Modifying the plot}

The main three ways to modify the plot are:

\begin{itemize}
  \item modifying existing grobs
  \item remove existing grobs
  \item add new grobs
  \item customise the layout
\end{itemize}

\noindent and these are described below.

\subsection{Modifying existing grobs}\label{sec:modifying_stuff}

Before you try to manually edit the grobs, check to make sure that there isn't an option that already controls the appearance.  See the first part of this chapter for more details.  Most of the difficulty in modifying stuff on the plot is figuring out the name of the grid you want to modify, and once you have that you can use  {\tt grid.edit} to change the graphical parameters of the model.  Remember, that grid graphic parameters (gpar) have the same argument names as base R (eg. cex, pch, col) not {\tt ggplot} (eg. size, shape, colour).  You can find a complete list of graphical parameters in {\tt ?gpar}.

To modifying grobs that appear in multiple places, make sure to set {\tt global=TRUE} so that every grob is modified, not just the first one with that name.  For most cases you will also need {\tt grep=TRUE}, which allows you to just match the important ggplot name of the grob, not the entire three part string.  These two options are the default for {\tt grid.gedit}.

In this example, we edit the font of all labels.

\begin{alltt}
qplot(mpg, wt, data=mtcars, facets = . ~ cyl)
grid.gedit("strip-text", gp=gpar(fontsize=8, fontface="italic"))
\end{alltt}

% decumar<<< 
% doptions(width=8, height=4)
% img({
% qplot(mpg, wt, data=mtcars, facets = . ~ cyl)
% grid.edit("label", gp=gpar(fontsize=8, fontface="italic"), grep=TRUE, global=TRUE)
% })
% |||
Error in editDLfromGPath(gPath, specs, strict, grep, global, redraw): 'gPath' (label) not found \\ 

% >>>

To edit just one type of label, we need to use the hierarchy of grobs.

\begin{alltt}
qplot(mpg, wt, data=mtcars, facets = . ~ cyl)
grid.gedit(gPath("strip","label"), gp=gpar(fontface="bold"))
grid.gedit(gPath("yaxis", "labels"), gp=gpar(col="red"))
\end{alltt}

or to modify just one labels:

\begin{alltt}
qplot(mpg, wt, data=mtcars, facets = . ~ cyl)
\end{alltt}

\subsection{Removing grobs}\label{ssub:removing_grobs}

You can use {\tt grid.remove} to completely remove a grob.

\begin{alltt}
qplot(mpg, wt, data=mtcars, facets = . ~ cyl)
grid.remove("strip-background", grep=TRUE, global=TRUE)
grid.remove("grill-background", grep=TRUE, global=TRUE)
grid.remove("major", grep=TRUE, global=TRUE)
grid.remove("axis", grep=TRUE, global=TRUE)

qplot(mpg, wt, data=mtcars, facets = . ~ cyl)
grid.remove("vertical", grep=TRUE, global=TRUE)
\end{alltt}

\subsection{Adding annotations}\label{sec:adding_annotation}

To add annotations to a plot you have to specify the viewport when you add extra grobs.  For example:

\begin{alltt}
p <- qplot(wt, mpg, data=mtcars, colour=cyl)
print(p, pretty=FALSE)
grid.circle(vp="layout::panel_1_1")
\end{alltt}

Panel viewports will have a coordinate system set up for points, while x- and y- axes will only have one dimension defined.  For example, on the x-axis there will be native coordinates for the x-dimension, but not the y-dimension.

\begin{alltt}
p <- qplot(wt, mpg, data=mtcars, colour=cyl)
print(p, pretty=FALSE)
grid.lines(x=unit(c(0,1), "npc"), y=unit(23, "native"), vp="layout::panel_1_1")
grid.lines(x=unit(c(0,1), "npc"), y=unit(23, "native"), vp="layout::axis_v_1_1")
\end{alltt}

% Draw a line across the whole plot is a bit trickier: you need find a viewport with the correct coordinate system, convert the measurement to a global coordinates and then draw using those coordinates.
% 
% \begin{alltt}
% print(p, pretty=FALSE)
% \end{alltt}
% 
% Alternatively, if you only want to draw lines, not place other grobs, you can use {\tt move.to} and {\tt line.to}.  See their help pages for more detail.
% 
% \begin{alltt}
% example here
% \end{alltt}
% 
% One other thing you may want to do when adding annotations is make the viewport bigger.  For example, if you are adding big labels on to the x-axis, there might not be enough space on the plot to display them.  
% 
% \begin{alltt}
% example here
% \end{alltt}
% 
Remember you can use {\tt current.vpTree(all=TRUE)} to remind you of what viewports are available to draw in.

\subsection{Customising layout}\label{sec:controlling_output}

By default, showing a {\tt ggplot} object at the R command prompt will display to the screen.  To exercise more control, you can call {\tt print} explicitly.  This section describes some of the things you can do.  For more details see {\tt ?print.ggplot} and {\tt ?ggplot\_print}.

If you just want the plot (no labels, titles or legends) you can use {\tt pretty = FALSE}

\begin{alltt}
p <- qplot(wt, mpg, data=mtcars, colour=cyl)
print(p, pretty = FALSE)
\end{alltt}

By default, {\tt ggplot} always clears the screen and draws to the entire device.  You customise this in two ways.  Firstly, you can setup a viewport and push it on to the display, then draw the plot with {\tt newpage=FALSE}:

\begin{alltt}
p <- qplot(wt, mpg, data=mtcars, colour=cyl)
grid.newpage()
pushViewport(viewport(height=0.4, width=0.4, x=0.4, y=0.8))
print(p, newpage=FALSE, pretty=FALSE)
upViewport()
\end{alltt}

Alternatively, you can set up your own set of viewports, and then specify which one the plot should be drawn to.

\begin{alltt}
grid.newpage()
pushViewport(viewport(height=0.5, width=0.5, x=0.5, y=0.5, name="small", angle=40))
upViewport()
print(p, vp="small")
\end{alltt}

Obviously, this is very useful if you want to layout plots in a complicated grid.  In this case, setup your grid using {\tt grid.layout} and then draw to it.

\begin{alltt}
p <- qplot(wt, mpg, data=mtcars, colour=cyl)

vplayout <- function(x, y) viewport(layout.pos.row=x, layout.pos.col=y)
grid.newpage()
pushViewport(viewport(layout=grid.layout(3,3)))

print(p, vp=vplayout(1,1))
print(p, vp=vplayout(2:3,2:3))
print(p, vp=vplayout(1, 2:3))
print(p, vp=vplayout(2:3, 1))
\end{alltt}

This is useful for arranging plots in a wider range of ways than what you can do with facetting.   You should be careful to ensure that scales are consistent over the different plots.  There is currently no easy way to do this, except to keep track of the maximum and minimum yourself, and then manually set the scales of the plot.

\begin{alltt}
Example to come
\end{alltt}

As the above example shows, you will probably want to use {\tt print(p, pretty=false)} and manually add grobs and viewports to draw the labels yourself.

\input{footer.tex}
