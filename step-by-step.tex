\input{header.tex}

\chapter{Understanding the grammar}

\section{Introduction}\label{sec:introduction}

% Introduction to grammar
% How my grammar differs from the grammar of graphics
% What the syntax looks like

You can choose to use just {\tt qplot} without any understanding of the underlying grammar, but you will be able to use only a small part of the power of ggplot.  By learning more about the grammar, and the components that make it up, you will be able to create a wider range of plots, as well as being able to combine multiple datasets, and write functions that operate on plots.  

This chapter describes of the grammar of graphics, and how the grammar of ggplot differs from the grammar of \citep{wilkinson:2006}.  I present two ways to think about the grammar: as an answer to a question, and as a pipeline of transformations.  You will also learn the R syntax used to create and combine the components to form an actual plot.  

% You will first learn what components make up a {\tt ggplot} plot object.  Next I explain the general structure of the functions and arguments in R that you use to create and link together the components.  Finally, I describe the options that control the general layout and appearance of all plots and how to control them.

This chapter is fairly theoretical, so you won't find too many examples of drawing plots.  However, a good understanding of how everything fits together will help you in creating your own plots.   The following chapters, 3-7, describe in detail the different components, provide many practical examples, and show you how to build you own components if the included ones aren't sufficient.  

%Use these, in conjunction with the help pages, to figure out what you need for your plot  

\section{What is a plot?}\label{sec:what_is_a_plot}

One way to think about the grammar of graphics is as a question: what is a plot?  The grammar answers this by describing a plot as a collection of independent components, each describing a particular part of the plot.

\begin{itemize}
	\item Data is obviously the most important part, and it is what you provide (all the other components are provided by {\tt ggplot}).  This is what you are try display visually to aid communication or analysis.

	\item {\bf Geoms}, short for geometric objects, control the type of plot that you create.  For example, using a point geom will create a box and whisker plot, while using a line geom will create a line plot.
	
	\item {\bf Stats}, or statistical transformations, reduce or augment the data in a statistical manner.  For example, a useful stat is the smoother, which shows the mean of y, conditional on x.  Another common stat is the binner, which bins data in to bins.   Every geom has a default statistic, and every statistic a default geom.  For example, the bin statistic has defaults to using the bar geom to produce a histogram.

	\item {\bf Scales} control the mapping from data attributes to aesthetic attributes.  They also provide an inverse mapping in the form of a guide, an axis or legend, which facilitates reading the final graphic.  Aesthetic attributes are things like position, size, colour---anything that you can perceive.  The function that maps data to aesthetic attributes is a scale. It takes values in data space (continuous or categorical) and maps them into an aesthetic space (eg. colour, size, shape).  A scale also provides guides to convert back from the aesthetic attribute to the original data.  Guides are either axes (for position) or legends (for everything else)
	
	\item {\bf Coords}, coordinate systems, map the position of objects on to the plane of the plot.
	
	\item There is also another thing that turns out to be sufficiently useful that we should include it in our general framework: facetting (also known as conditioned or trellis plots).  This allows us to easily create small multiples of different subsets of an entire dataset.  This is a powerful tool when investigating whether patterns hold across all conditions.
	
\end{itemize}

This breakdown is similar to The Grammar of Graphics, but three components are missing: the algebra, the transformation stage, and guides.  These were dropped for the following reasons:

\begin{itemize}
	\item Variable transformations are already easy in R so are omitted.
	
	\item The data reshapings of the algebra are instead performed by the reshape package \citep{reshape}.  This is part of my philosophy that data manipulation should be separated from display as much as possible.
	
	\item Guides are largely drawn automatically.  I have created geoms that correspond to some annotations as these are often data dependent in some way, and may need to be different in different facets of the plot.  Additionally, grid can be used to draw directly on the plot.
\end{itemize}

I have renamed the element component to geom (after consultation with Lee Wilkinson) to better describe what it is.  Additionally, my descriptions are less formal than those of The Grammar.  

\section{The pipeline}\label{sec:the_pipeline}

Another way of thinking about the grammar of graphics is as a pipeline which takes in raw data and outputs plots.  Each stage of the pipeline performs a transformation described by one of the components of the grammar.  For example, one of the first stages performs the statistical transformation described by the stat component.  

The pipelines of ggplot and the GoG differ slightly.  In ggplot, every stage takes a data frame as input and returns a data frame as output, apart from the final stage, which outputs grid grobs (graphical objects).  The GoG has three intermediate data formats: a varset (the same as a data frame), a graph and a graphic.

[Insert diagram of the pipelines here.]

The pipeline is a little more complicated when multiple data sources and geoms are involved.  The complication arises because all data must share the same scales and coordinate system, but may use different mappings, geoms and statistics.  All pipelines must share the same coordinate system, so this is where the connection occurs.  For this reason, ggplot uses an intermediate object (currently) called a {\bf promise} which combines the geom, stat, data and mapping (plot defaults used if not otherwise specified).  The GoG does not describe this.

[Note to Debby: this is really important.  The (data + mapping + stat + geom) is themost important component but I don't think I've described it enough]

[Insert more complicated diagram here]

\section{Syntax of the grammar}

The biggest difference between The Grammar of Graphics and the grammar used in ggplot is how the grammar is written.  The Grammar of Graphics uses two specifications.  A concise format is used to caption figure, and a more detailed xml format stored on disk.  The concise format looks something like:

\begin{verbatim}
DATA: source("demographics")
DATA: longitude, latitude = map(source("World"))
TRANS: bd = max(birth - death, 0)
COORD: project.mercator()
ELEMENT: point(position(lon * lat), size(bf), color(color.red))
ELEMENT: polygon(position(longitude * latitude))
\end{verbatim}

[Note to Debby: if you have the latest copy this is on page 13, figure 1.5.  I have added the first data specification as it is omitted in the book, but doesn't make much sense without it.  I have no clue how the multiple datasets (one demographic, one map) are dealt with in the Grammmar - Lee doesn't discuss this at all.]

To make this work in R, we need to make a few changes.  Its equivalent in ggplot would be:

\begin{verbatim}
demographics <- transform(demographics, bd = max(birth - death, 0))
ggplot(data=demographic, aes(x=lon, y=lat)) + 
  geom_point(aes(size=bd), colour="red") +
  geom_polygon(data=world) +
  coord_map(projection="mercator")
\end{verbatim}

\noindent This example is sophisticated, and the parts that make it up are described below.

\begin{itemize}
	\item {\tt ggplot} specifies the data, default aesthetic mappings and facetting. (you can also {\tt qplot} which does this and more).  It creates a plot object which we then supplement with the other components of the plot.  {\tt aes} is short for aesthetic mapping and specifies which variables in the data should be mapped to which aesthetic attributes.  (Scales then specify {\em how} this should occur).
	
	\item $+$ is used to add components to this plot.  Each component is named {\tt component type\_component name}.  All components are always written in the singular eg. {\tt geom\_point}, {\tt geom\_polygon}.
	
	\item Geoms can override the default data and aesthetic mappings provided by the plot.  Each geom also has a default statistic which is used to transform the data prior to plotting.  For the geoms in the above example, the default statistic is the identity function.  
		
	\item In both the ggplot and GoG examples, scales are defined by default.  In ggplot you can override the defaults by adding a scale object, e.g. {\tt scale\_colour} or {\tt scale\_size}
	
	\item The coordinate system uses a slightly different format.  In general, most of the object specifications in ggplot are slightly different to those in GoG, in order to be more familiar to R users.
\end{itemize}

There is also a global plot object ({\tt .PLOT}) which records the last plot.  This can be useful if you forgot to save the last output.

% \subsection{Data, defaults and facetting}\label{sub:data_defaults_and_facetting}
% 
% The plot object starts off very simple: it is just a set of defaults, with no visual display.  This is what the function {\tt ggplot} will set up.  
% 
% To start a plot, the bare minimum you need is a data frame:
% 
% \begin{alltt}
% p <- ggplot(diamonds)
% \end{alltt}
% 
% You can supply a facetting formula (as described in Chapter XXX) and margins, which describe how to form small multiples of the plot.
% 
% \begin{alltt}
% p <- ggplot(diamonds, colour ~ cut, margins=TRUE)
% \end{alltt}
% 
% You can also supply a list of default aesthetics mappings.  This should be of the form {\tt aes(aesthetic attribute = data attribute)}.   These will be used by all geoms that support them, and otherwise will be silently ignored.  Careful use of the defaults will save you some typing, but if you don't know what you need you can just leave them blank.  All of the defaults can be overridden when adding geoms later on.
% 
% \begin{alltt}
% p <- ggplot(diamonds, aes(colour = colour, shape = cut))  
% \end{alltt}
% 
% You can find out more about the different aesthetic mappings available for each geom in chapter XXX, and how to exercise control over the default scales in chapter XXX.
% 
% You can modify these settings after you have created the plot using {\tt setfacets} and {\tt setdefaults}.  You can modify the default data set using {\tt setdata}.  This makes it easy to set up a plot and change the data set that it is based on, or to add facetting after you have set up everything else.
% 
% \subsection{Graphical objects}\label{sub:graphical_objects}
% 
% Once you have set up the defaults, you will want to add graphical objects to the plot.  There is a separate function for each type of graphical object, but they all have a very similar structure.  All of the geom functions start with {\tt gg}.  Chapter XXX lists all of the geom functions, and explains in detail their function and options that they take.  There is also a list of all geoms in {\tt ?ggplot}, which will also contain any added since this book was printed.
% 
% If you want to use the defaults you set up when creating the plot object, , you just use the geom function like:
% 
% \begin{alltt}
% p + geom_line()
% \end{alltt}
% 
% This will create a new plot object with a lines geom added to its list of geoms.  By default, this object will be plotted, so that you see the effect of the geom function immediatly.  You can also add more aesthetics, or specify a different data set to use instead of the default.  
% 
% \begin{alltt}
% p + geom_line(aes(colour=a, size=b), data=new.data.frame))
% \end{alltt}
% 
% If there is a default aesthetic you want to unset, use {\tt NULL}:
% 
% \begin{alltt}
% p + geom_line(p, aes(colour=NULL))
% \end{alltt}
% 
% If the plot is facetted, and the new data set does not contain the facetting columns, then the data set will be duplicated for each value of the missing columns.  This has the effect of displaying the data in every facet.  This is explained in more detail, with examples, in chapter XXX, page X.
% 
% For every aesthetic the geom function understands, you can also supply that aesthetic as an option to the function.  Instead of mapping data to that aesthetic, this will change the default.  For example.
% 
% \begin{alltt}
% p + geom_line(colour="red")  
% \end{alltt}
% 
% \noindent will set the line colour to be red instead of black.  Other examples:
% 
% \begin{alltt}
% p + geom_line(size=3)  
% p + geom_line(size=3, colour="blue")  
% \end{alltt}
% 
% These changes to the aesthetic attributes will not appear in the legend.  If you do want to   manually set the aesthetic attributes, you can use a scale specially design to do that, {\tt scmanual}.  This scale provides a number of options that you can use to customise the legend.  See page XXX for more details.
% 
% \subsection{Scales}\label{sub:scales}
% 
% By default, whenever you specify an aesthetic mapping (eg. {\tt colour=a}) a default scale is automatically added to the plot object (eg. {\tt scale_colour_gradient}).  However, if the default does not do what you want, you will have to manual add a scale to overwrite the existing default.  You do this with scale functions.  Scales are described in detail in chapter XXX.
% 
% Scales are not quite as regular as geom functions, because they have a greater range of appearances.  
% 
% Two types of scales: for continuous data, and for categorical data
% 
% \begin{tabular}{l|p{1in}l}
%  & position & other\\
% \hline
% categorical & 
% Testing one two threee
% 
% How does it work
% r2c2 & r2c3\\
% continuous & r3c2 & r3c3\\
% \hline
% \end{tabular}
% 
% All scales take (at least) the following arguments:
% 
% \begin{itemize}
%   \item name
% \end{itemize}
% 
% Most continuous scales also have:
% 
% \begin{itemize}
%   \item range
%   \item expand
%   \item breaks
%   \item transform
% \end{itemize}
% 
% Most categorical scales also have:
% 
% \begin{itemize}
%   \item range
%   \item breaks
%   \item labels
% \end{itemize}



\input{footer.tex}
